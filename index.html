<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BrahminBazaar — Vyaasa Trade & Logistix LLP</title>
  <meta name="description" content="BrahminBazaar - fresh staples, spices, oils and more. Clean UI, persistent cart."/>
  <style>
    /* ROOT COLORS */
    :root{
       --primary-dark:#00796b;    /* Dark Teal */
       --primary:#009688;         /* Medium Teal - Accent */
       --primary-light:#4db6ac;   /* Light Teal */
       --accent:var(--primary); 
       --text-dark:#1a1a1a;        /* High Contrast Text Color */
       --muted:#6b7280;
       --card:#ffffff;
       --bg:#f8f8f8; /* Very light gray background */
       --glass: rgba(255,255,255,0.90);
       --radius:14px;
       --shadow: 0 12px 30px rgba(12,24,12,0.06);
       --max-width:1200px;
    }

    
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      color:#333333; 
      padding-bottom:80px;

    }
    /* HEADER - WHITE WITH THIN TEAL LINE */
    header{
      background: var(--card); 
      color:#333333; 
      padding:18px 20px;
      box-shadow: 0 2px 0 0 var(--accent), 0 4px 6px rgba(0,0,0,0.05); 
      position:sticky;top:0;z-index:100;
    }

    .products-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px}
    @media (max-width:1100px){ .products-grid{grid-template-columns:1fr} }
    .product-card{
      background:var(--card);
      border-radius:16px;
      padding:14px;
      box-shadow:var(--shadow);
      display:flex;
      gap:14px;
      align-items:flex-start;
      transition:transform .14s ease, box-shadow .14s ease;
      border: 1px solid #eeeeee; 
    }
    .product-card:hover{transform:translateY(-6px);box-shadow:0 22px 50px rgba(8,40,10,0.08)}
    .product-media{width:190px;height:140px;border-radius:12px;overflow:hidden;flex-shrink:0;background:#f6faf6;display:flex;align-items:center;justify-content:center}
    .product-media img{width:100%;height:100%;object-fit:cover}
    .product-info{flex:1}
    .product-info h3{margin:0 0 6px;color:var(--text-dark);font-size:1.05rem} 
    .meta{color:var(--muted);font-size:13px}
    .price{font-weight:800;color:var(--accent);margin-top:8px} 
    .product-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 12px;
      flex-wrap: wrap; 
    }
    
    @media (max-width: 600px) {
        .product-card {
            flex-direction: column; 
            align-items: stretch;
            padding-bottom: 20px; 
        }
        .product-media {
            width: 100%; 
            height: 180px; 
            margin-bottom: 14px;
        }
    }

    .wrap{max-width:var(--max-width);margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:18px;}

    .brand{display:flex;align-items:center;gap:14px;}
    .logo{
      height:60px;
      width:auto;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .logo img{
      height:60px;
      width:auto;
      object-fit:contain;
      display:block;
    }

    h1{font-size:28px;margin:0; color:#333333} 
    /* Style for the new tagline (using existing class for size) */
    .tag{font-size:13px;opacity:0.9; color:#666666; margin-top: 2px;}


    /* Controls (search small right) */
    .controls{display:flex;gap:12px;align-items:center}
    
    /* Very Small Header Contact Button Style */
    .small-header-btn {
        background: var(--primary);
        color: white;
        border: 0;
        padding: 8px 12px; /* Made smaller */
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        transition: background 0.2s ease;
        font-size: 14px;
        white-space: nowrap; /* Prevent wrapping */
    }
    .small-header-btn:hover { background: var(--primary-dark); }
    @media (max-width: 500px) {
        .small-header-btn { padding: 6px 10px; font-size: 13px; } 
    }
    
    .search{
      display:flex;align-items:center;background:#f7f7f7;padding:8px;border-radius:12px;border:1px solid #eee; 
    }
    .search svg{opacity:.8;margin-right:8px}
    .search input{border:0;background:transparent;outline:none;min-width:170px;font-size:14px;padding:6px}
    /* Cart button on header - Teal outline */
    .cart-btn{
        background:transparent;
        border:1px solid var(--accent); 
        padding:10px 14px;
        border-radius:10px;
        color:var(--accent); 
        font-weight:700;
        cursor:pointer;
        white-space: nowrap;
    }
    .cart-btn:hover { background: rgba(0, 150, 136, 0.05); }


    /* Make header dynamic on smaller devices */
    @media (max-width: 768px) {
      .search input {
        min-width: 100px; 
      }
    }
    @media (max-width: 500px) {
      .wrap {
        flex-wrap: wrap; 
        justify-content: center;
      }
      .controls {
        width: 100%;
        margin-top: 10px;
        justify-content: space-between;
      }
      .search {
        flex-grow: 1; 
        min-width: 150px;
      }
      /* Removed the order:-1 for cart-btn to respect the new HTML order (Search - Cart - Chat) */
    }

    /* Main layout - REVERTED TO 2 COLUMNS */
    main{max-width:var(--max-width);margin:22px auto;display:grid;grid-template-columns:1fr 360px;gap:22px;padding:0 18px}
    @media (max-width:980px){ main{grid-template-columns:1fr;padding:0 14px} .cart{position:static} }

    /* Right cart panel */
    .cart{
      background:var(--card);
      border-radius:12px;
      padding:16px;
      box-shadow:var(--shadow);
      position:sticky;
      top:100px;
      height:fit-content;
      border: 1px solid #eeeeee;
    }
    
    /* Contact Box Style - MOVED TO NEW BOTTOM SECTION */
    .contact-box{
      max-width: 500px; /* Limit width for aesthetic */
      margin: 0 auto; /* Center it */
      background:var(--card);
      border-radius:12px;
      padding:25px;
      box-shadow:var(--shadow);
      border: 1px solid #eeeeee;
      text-align: center;
    }
    
    /* Large WhatsApp Button Styles (kept from last step) */
    .btn-whatsapp-large {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%; 
        padding: 14px 20px;
        background: linear-gradient(180deg, var(--primary), var(--primary-dark)); 
        color: white;
        border-radius: 10px;
        font-weight: 800;
        text-decoration: none;
        box-shadow: 0 10px 20px rgba(0, 150, 136, 0.2);
        transition: 0.2s ease;
        margin-top: 15px; /* Increased margin */
    }
    .btn-whatsapp-large:hover {
        filter: brightness(1.1);
        transform: translateY(-2px);
        box-shadow: 0 14px 25px rgba(0, 150, 136, 0.3);
    }
    .btn-whatsapp-large svg {
        margin-right: 10px;
        stroke: white;
        fill: none;
    }
    
    /* Filters, Buttons, Modal styles remain unchanged */
    .top-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:12px}
    .title-section h2{margin:0;color:var(--text-dark)} 
    .title-section p{margin:4px 0 0;font-size:13px;color:var(--muted)}
    .filters{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .chip{background:var(--card);padding:10px 14px;border-radius:999px;border:1px solid rgba(16,24,16,0.04);cursor:pointer;font-weight:700}
    .chip.active{
        background:linear-gradient(90deg, #e0f2f1, #e0f7fa); 
        border:1px solid var(--primary-light); 
        color:var(--primary-dark); 
        box-shadow:0 10px 30px rgba(0,150,136,0.08); 
    }
 
    .controls-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select, input[type="number"]{padding:8px 10px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);outline:none;background:white}

    .btn-choose {
      background: linear-gradient(180deg, var(--primary), var(--primary-dark)); 
      color: #ffffff;
      border: 0;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 800;
      cursor: pointer;
      transition: 0.2s ease;
    }

   .btn-choose:hover {
     filter: brightness(1.1);
     transform: translateY(-2px);
   }

     .btn-alt {
       background: transparent;
       border: 1px solid rgba(0,0,0,0.12);
       padding: 8px 10px;
       border-radius: 10px;
       cursor: pointer;
       font-weight: 600;
       transition: 0.2s ease;
     }

     .btn-alt:hover {
       background: rgba(0,0,0,0.04);
     }

    .cart h3{margin:0 0 10px 0}
    .cart-list{display:flex;flex-direction:column;gap:12px;max-height:420px;overflow:auto;padding-right:6px}
    .cart-item{display:flex;gap:12px;align-items:center}
    .cart-item img{width:64px;height:64px;border-radius:8px;object-fit:cover}
    .cart-item .meta{flex:1}
    .cart-item .meta b{display:block}
    .cart-item .meta small{color:var(--muted)}
    .qty-controls{display:flex;align-items:center;gap:6px;margin-top:8px}
    .small-btn{background:#f3f4f6;border:0;padding:6px 8px;border-radius:8px;cursor:pointer}
    .checkout{width:100%;background:var(--accent);color:white;border:0;padding:12px;border-radius:10px;font-weight:800;margin-top:12px;cursor:pointer}
    .checkout:hover { filter: brightness(1.1); } 

    .modal-back{position:fixed;inset:0;background:rgba(4,6,8,0.45);display:none;align-items:center;justify-content:center;z-index:120}
    .modal{background:var(--card);padding:18px;border-radius:12px;max-width:640px;width:96%;box-shadow:0 20px 40px rgba(12,18,20,0.28)}
    .modal .row{display:flex;gap:12px;flex-wrap:wrap}
    .option-list{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .option{padding:8px 10px;border-radius:10px;border:1px solid #eee;cursor:pointer}
    .option.active{border-color:var(--accent);box-shadow:0 12px 30px rgba(0,150,136,0.06)} 

    .empty{
      padding:30px;
      border-radius:12px;
      text-align:center;
      background:linear-gradient(180deg,#fff,#fffdf6);
      border:1px dashed rgba(0,150,136,0.15); 
    }
    footer{max-width:var(--max-width);margin:28px auto 60px;padding:0 18px;color:var(--muted);display:flex;align-items:center;justify-content:space-between}
    footer small{color:var(--muted)}
    .muted{color:var(--muted)}
  </style>
</head>
<body>

  <header>
    <div class="wrap">

      <div class="brand">
        <div class="logo"><img src="logo.png" alt="BrahminBazaar Logo"></div>
        <div>
          <h1>BrahminBazaar</h1>
          <div class="tag">Restoring Traditions...</div>
        </div>
      </div>
      
      <div class="controls">
        
        <div class="search" role="search" aria-label="Search products">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="#333333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6" stroke="#333333" stroke-width="2"/></svg>
          <input id="search" placeholder="Search rice, dal, spices..." />
        </div>

        <button id="openCart" class="cart-btn" title="Open cart">Cart (<span id="cartCount">0</span>)</button>
        
        <button id="headerContactBtn" class="small-header-btn" title="Contact us via chat">Chat</button>

      </div>
    </div>
  </header>

  <main>
    <section>
      <div class="top-row">
        <div class="title-section">
          <h2>Shop essentials — Rice, Dals, Spices & more</h2>
          <p class="muted">Click a category to filter. Click a product to choose variety & quantity.</p>
        </div>

        <div class="controls-row">
          <label class="muted" for="sort">Sort</label>
          <select id="sort">
            <option value="default">Recommended</option>
            <option value="price-asc">Price: Low → High</option>
            <option value="price-desc">Price: High → Low</option>
          </select>
        </div>
      </div>

      <div class="filters" id="categoryChips"></div>

      <div id="productsGrid" class="products-grid" style="margin-top:18px">
        </div>

      <div id="noResults" style="display:none;margin-top:22px">
        <div class="empty">No products found — try another search or category.</div>
      </div>
    </section>

    <aside>
      <div class="cart" id="cartPanel" aria-live="polite">
        <h3>Cart</h3>
        <div id="cartList" class="cart-list">
          <div class="muted">Your cart is empty</div>
        </div>

        <div style="display:flex;justify-content:space-between;margin-top:12px;align-items:center">
          <div><small class="muted">Subtotal</small><div id="subtotal" style="font-weight:800">₹0.00</div></div>
          <div style="text-align:right"><small class="muted">Items</small><div id="cartItemsCount">0</div></div>
        </div>

        <button class="checkout" id="checkoutBtn" onclick="checkout()" disabled>Proceed to Checkout</button>
        <div style="font-size:12px;color:var(--muted);margin-top:8px">Checkout is a placeholder — integrate payment gateway (Razorpay/UPI) when ready.</div>
      </div>
    </aside>
  </main>

  <section id="contactSection" style="max-width: 100%; padding: 0 18px; margin: 30px auto 30px; display: block;">
    <div class="contact-box" aria-label="Contact Information">
        <h3>Need Help?</h3>
        <p class="muted" style="margin-top:8px;">Have questions about products, delivery, or custom orders? Tap the button below to chat with us instantly on WhatsApp.</p>
        
        <a id="whatsappBtnLarge" class="btn-whatsapp-large" href="#" target="_blank" title="Chat with us on WhatsApp">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            Chat on WhatsApp
        </a>
        
        <div style="font-size:12px;color:var(--muted);margin-top:10px;">We respond quickly during business hours.</div>
    </div>
  </section>

  <div id="modalBack" class="modal-back" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" id="modalContent"></div>
  </div>

  <footer>
    <div class="legal">© <span id="year"></span> VYTAL. All rights reserved.</div>
    <small>Designed by Sundar Rajan Aathreya</small>
  </footer>

  <script>
    /*******************************
     * DATA
     *******************************/
    // Each product: id, category, title, basePrice (per kg for solids, per litre for oils), img, varieties optional, oil flag optional
    const PRODUCTS = [
      // Rice (sizes: 225g,450g,1kg,2kg,5kg,25kg)
      {id:'rice-sona', category:'Rice', title:'Sona Masoori', basePrice: 60, img:'https://via.placeholder.com/400x300?text=Sona+Masoori', varieties:['Raw','Steam','Parboiled']},
      {id:'rice-ponni', category:'Rice', title:'Ponni Rice', basePrice: 55, img:'https://via.placeholder.com/400x300?text=Ponni+rice', varieties:['Raw', 'Steamed']},
      // FIX: The 'varieties' property was placed incorrectly outside the object literal's curly braces.
      {id:'rice-kolam', category:'Rice', title:'Kolam Rice', basePrice: 45, img:'https://via.placeholder.com/400x300?text=Kolam+Rice', varieties:['Raw','Steam','Parboiled']},
      {id:'rice-basmati', category:'Rice', title:'Basmati', basePrice: 170, img:'https://via.placeholder.com/400x300?text=Basmati', varieties:['Standard','Aged']},
      {id:'rice-idly', category:'Rice', title:'Idly Rice', basePrice: 55, img:'https://via.placeholder.com/400x300?text=Idly+rice'},
      {id:'rice-red', category:'Rice', title:'Red Rice', basePrice: 85, img:'https://via.placeholder.com/400x300?text=Red+Rice'},


      // Dals (sizes: 225g,450g,1kg,2kg,5kg)
      {id:'dal-toor', category:'Dals', title:'Toor Dal', basePrice: 140, img:'https://via.placeholder.com/400x300?text=Toor+Dal'},
      {id:'dal-urad', category:'Dals', title:'Urad Dal', basePrice: 120, img:'https://via.placeholder.com/400x300?text=Urad+Dal'},
      {id:'dal-moong', category:'Dals', title:'Moong Dal', basePrice: 120, img:'https://via.placeholder.com/400x300?text=Moong+Dal'},
      {id:'dal-masoor', category:'Dals', title:'Masoor Dal', basePrice: 110, img:'https://via.placeholder.com/400x300?text=Masoor+Dal'},

      // Spices (sizes: 225g,450g,1kg,2kg,5kg)
      {id:'sp-turmeric', category:'Spices', title:'Turmeric Powder', basePrice: 300, img:'https://via.placeholder.com/400x300?text=Turmeric'},
      {id:'sp-chilli', category:'Spices', title:'Chilli Powder', basePrice: 220, img:'https://via.placeholder.com/400x300?text=Chilli'},
      {id:'sp-pepper', category:'Spices', title:'Pepper', basePrice: 160, img:'https://via.placeholder.com/400x300?text=Pepper', varieties:['Seeds','Powder']},
      {id:'sp-coriander', category:'Spices', title:'Coriander', basePrice: 160, img:'https://via.placeholder.com/400x300?text=Coriander', varieties:['Seeds','Powder']},
      {id:'sp-cumin', category:'Spices', title:'Cumin', basePrice: 160, img:'https://via.placeholder.com/400x300?text=Cumin', varieties:['Seeds','Powder']},

      // Oils (sizes: 225ml,450ml,1L,2L,5L) — basePrice is per L (1000 ml)
      {id:'oil-gingelly', category:'Oils', title:'Gingelly (Sesame) Oil', basePrice: 420, img:'https://via.placeholder.com/400x300?text=Gingelly+Oil', oil:true},
      {id:'oil-coconut', category:'Oils', title:'Coconut Oil', basePrice: 260, img:'https://via.placeholder.com/400x300?text=Coconut+Oil', oil:true},
      {id:'oil-groundnut', category:'Oils', title:'Groundnut Oil', basePrice: 220, img:'https://via.placeholder.com/400x300?text=Groundnut+Oil', oil:true},
      {id:'oil-sunflower', category:'Oils', title:'Sunflower Oil', basePrice: 220, img:'https://via.placeholder.com/400x300?text=Sunflower+Oil', oil:true},

      // Salts (sizes: 225g,450g,1kg,2kg,5kg)
      {id:'salt-sea', category:'Salts', title:'Sea Salt', basePrice: 40, img:'https://via.placeholder.com/400x300?text=Sea+Salt'},
      {id:'salt-rock', category:'Salts', title:'Rock Salt', basePrice: 40, img:'https://via.placeholder.com/400x300?text=Rock+Salt'},
      {id:'salt-pink', category:'Salts', title:'Himalayan Pink Salt', basePrice: 40, img:'https://via.placeholder.com/400x300?text=Pink+Salt'},
      {id:'salt-black', category:'Salts', title:'Black Salt', basePrice: 40, img:'https://via.placeholder.com/400x300?text=Black+Salt'},
     
      // Flours (sizes: 225g,450g,1kg,2kg,5kg)
      {id:'flour-wheat', category:'Flours', title:'Wheat Flour (Atta)', basePrice: 35, img:'https://via.placeholder.com/400x300?text=Wheat+Flour'},
      {id:'flour-rice', category:'Flours', title:'Rice Flour', basePrice: 35, img:'https://via.placeholder.com/400x300?text=Rice+Flour'},
      {id:'flour-gram', category:'Flours', title:'Gram Flour (Channa Besan)', basePrice: 35, img:'https://via.placeholder.com/400x300?text=Gram+Flour'},
      {id:'flour-ragi', category:'Flours', title:'Ragi Flour', basePrice: 35, img:'https://via.placeholder.com/400x300?text=Ragi+Flour'},
      {id:'flour-maida', category:'Flours', title:'Maida Flour', basePrice: 35, img:'https://via.placeholder.com/400x300?text=Maida+Flour'},

      // Millets (sizes: 225g,450g,1kg,2kg,5kg)
      {id:'millet-Finger', category:'Millets', title:'Finger Millets (Ragi)', basePrice: 80, img:'https://via.placeholder.com/400x300?text=Finger+Millets'},
      {id:'millet-Sorghum', category:'Millets', title:'Sorghum Millets (Jowar)', basePrice: 80, img:'https://via.placeholder.com/400x300?text=Sorghum+Millets'},
      {id:'millet-Foxtail', category:'Millets', title:'Foxtail Millets (Kangni)', basePrice: 80, img:'https://via.placeholder.com/400x300?text=Foxtail+Millets'},
      {id:'millet-Pearl', category:'Millets', title:'Pearl Millets (Bajra)', basePrice: 80, img:'https://via.placeholder.com/400x300?text=Pearl+Millets'},

      // Other Grains (sizes: 225g,450g,1kg,2kg,5kg)
      {id:'grains-wheat', category:'Other Grains', title:'Wheat', basePrice: 140, img:'https://via.placeholder.com/400x300?text=Wheat+Grains'},
      {id:'grains-maize', category:'Other Grains', title:'Maize', basePrice: 120, img:'https://via.placeholder.com/400x300?text=Maize+Grains'},
      {id:'grains-barley', category:'Other Grains', title:'Barley', basePrice: 120, img:'https://via.placeholder.com/400x300?text=Barley+Grains'},
      {id:'grains-oats', category:'Other Grains', title:'Oats', basePrice: 110, img:'https://via.placeholder.com/400x300?text=Oats+Grains'},

      // Beverages (sizes: 225g,450g,1kg,2kg)
      {id:'bev-tea', category:'Beverages', title:'Premium Tea (Loose)', basePrice: 250, img:'https://via.placeholder.com/400x300?text=Tea'},
      {id:'bev-coffee', category:'Beverages', title:'Coffee Powder', basePrice: 450, img:'https://via.placeholder.com/400x300?text=Coffee'},
      {id:'bev-Badam Mix', category:'Beverages', title:'Badam Mix Powder', basePrice: 450, img:'https://via.placeholder.com/400x300?text=Badam Milk'},
      {id:'bev-Rosemilk Mix', category:'Beverages', title:'Rosemilk Mix Powder', basePrice: 450, img:'https://via.placeholder.com/400x300?text=Rosemilk'},
    ];

    // Categories (display order)
    const CATEGORIES = ['All','Rice','Dals','Spices','Oils','Salts','Flours','Millets','Other Grains','Beverages'];

    // Allowed quantities per category (strings shown to user). We'll map to numeric grams/ml when computing.
    const QUANTITIES = {
      'Rice': ['225g','450g','1kg','2kg','5kg','25kg'],
      'Dals': ['225g','450g','1kg','2kg','5kg'],
      'Spices': ['225g','450g','1kg','2kg','5kg'],
      'Salts': ['225g','450g','1kg','2kg','5kg'],
      'Flours': ['225g','450g','1kg','2kg','5kg'],
      'Millets': ['225g','450g','1kg','2kg','5kg'],
      'Grains': ['225g','450g','1kg','2kg','5kg'],
      'Beverages': ['225g','450g','1kg','2kg'],
      'Oils': ['225ml','450ml','1L','2L','5L'],
      'All': ['225g','450g','1kg','2kg','5kg']
    };

    /*******************************
     * STATE & STORAGE
     *******************************/
    const STORAGE_KEY = 'brahminbazaar_cart_v2';
    let state = { category: 'All', search:'', sort:'default', cart: [] };

    // load cart from localStorage (persistent)
    (function loadCart(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw) state.cart = JSON.parse(raw);
      }catch(e){ state.cart = [];}
    })();

    function saveCart(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.cart)); renderCart(); }

    /*******************************
     * HELPERS
     *******************************/
    function money(n){ return '₹' + Number(n).toFixed(2); }

    // convert quantity string to grams or ml numeric
    function qtyToUnits(qstr){
      if(!qstr) return 0;
      if(qstr.endsWith('kg')) return Number(qstr.replace('kg','')) * 1000; // grams
      if(qstr.endsWith('g')) return Number(qstr.replace('g',''));
      if(qstr.endsWith('L')) return Number(qstr.replace('L','')) * 1000; // ml
      if(qstr.endsWith('l')) return Number(qstr.replace(/[^0-9.]/g,'')) * 1000;
      if(qstr.endsWith('ml')) return Number(qstr.replace('ml',''));
      if(qstr.endsWith('100g')) return 100;
      return Number(qstr) || 0;
    }

    // compute price for product for one pack of 'qstr' (like '225g' or '1L' for oils)
    function pricePerPack(product, qstr){
      if(product.oil){
        // basePrice is per 1 L (1000 ml)
        const ml = qtyToUnits(qstr);
        const pricePerL = product.basePrice || 0;
        return (pricePerL/1000) * ml;
      } else {
        // basePrice per kg => per 1000 g
        const g = qtyToUnits(qstr);
        const pricePerKg = product.basePrice || 0;
        return (pricePerKg/1000) * g;
      }
    }

    /*******************************
     * UI RENDER
     *******************************/
    const chipsWrap = document.getElementById('categoryChips');
    const productsGrid = document.getElementById('productsGrid');
    const noResults = document.getElementById('noResults');
    const searchEl = document.getElementById('search');
    const sortEl = document.getElementById('sort');

    // render category chips
    CATEGORIES.forEach(cat=>{
      const el = document.createElement('div');
      el.className = 'chip' + (cat==='All' ? ' active' : '');
      el.textContent = cat;
      el.onclick = () => {
        document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
        el.classList.add('active');
        state.category = cat;
        renderProducts();
        window.scrollTo({top:160, behavior:'smooth'});
      };
      chipsWrap.appendChild(el);
    });

    // search & sort handlers
    searchEl.addEventListener('input', e => { state.search = e.target.value.trim().toLowerCase(); renderProducts(); });
    sortEl.addEventListener('change', e => { state.sort = e.target.value; renderProducts(); });

    function renderProducts(){
      productsGrid.innerHTML = '';
      let list = PRODUCTS.filter(p => {
        if(state.category !== 'All' && p.category !== state.category) return false;
        if(state.search){
          const hay = (p.title + ' ' + (p.varieties||[]).join(' ') + ' ' + p.category).toLowerCase();
          if(!hay.includes(state.search)) return false;
        }
        return true;
      });

      if(state.sort === 'price-asc') list.sort((a,b) => a.basePrice - b.basePrice);
      if(state.sort === 'price-desc') list.sort((a,b) => b.basePrice - a.basePrice);

      if(list.length === 0){ noResults.style.display='block'; } else { noResults.style.display='none'; }

      list.forEach(p => {
        const card = document.createElement('article');
        card.className = 'product-card';
        card.innerHTML = `
          <div class="product-media" aria-hidden>
            <img src="${p.img}" alt="${p.title}" loading="lazy">
          </div>
          <div class="product-info">
            <h3>${p.title}</h3>
            <div class="meta">${p.category}</div>
            <div class="price">${p.oil ? money(p.basePrice) + ' / L' : money(p.basePrice) + ' / kg'}</div>
            <div class="product-actions">
              <button class="btn-choose" data-id="${p.id}" aria-label="Choose ${p.title}">Choose & Add</button>
              <button class="btn-alt" data-id="${p.id}" aria-label="View details">Details</button>
              <div style="margin-left:auto;color:var(--muted);font-size:13px">Start ${p.oil ? '225ml' : '225g'}</div>
            </div>
          </div>
        `;
        productsGrid.appendChild(card);
      });
    }

    /*******************************
     * MODAL: choose variety & quantity (inline modal)
     *******************************/
    const modalBack = document.getElementById('modalBack');
    const modalContent = document.getElementById('modalContent');

    // delegated click for choose buttons
    document.addEventListener('click', (e) => {
      const choose = e.target.closest('.btn-choose, .btn-alt');
      if(!choose) return;
      const pid = choose.dataset.id;
      if(!pid) return;
      openProductModal(pid);
    });

    function openProductModal(productId){
      const p = PRODUCTS.find(x => x.id === productId);
      if(!p) return;
      // allowed qty options
      const allowed = QUANTITIES[p.category] || QUANTITIES['All'];
      // build modal content
      modalContent.innerHTML = '';
      const html = document.createElement('div');

      html.innerHTML = `
        <div style="display:flex;gap:14px;align-items:center">
          <div style="width:150px;height:110px;border-radius:10px;overflow:hidden;background:#f6faf6;flex-shrink:0">
            <img src="${p.img}" alt="${p.title}" style="width:100%;height:100%;object-fit:cover">
          </div>
          <div>
            <h3 style="margin:0">${p.title}</h3>
            <div class="muted" style="margin-top:6px">${p.category} • ${p.oil ? money(p.basePrice)+' / L' : money(p.basePrice)+' / kg'}</div>
            <div style="margin-top:10px;font-size:13px;color:var(--muted)">Pick a variety (if available) and a pack size — then add number of packs.</div>
          </div>
        </div>
      `;
      modalContent.appendChild(html);

      // variety select
      if(p.varieties && p.varieties.length){
        const vwrap = document.createElement('div'); vwrap.style.marginTop = '12px';
        vwrap.innerHTML = `<label style="font-weight:700">Variety</label>`;
        const sel = document.createElement('select'); sel.style.marginTop='8px';
        p.varieties.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
        vwrap.appendChild(sel);
        modalContent.appendChild(vwrap);
      }

      // pack size options
      const sizeWrap = document.createElement('div'); sizeWrap.style.marginTop = '12px';
      sizeWrap.innerHTML = `<label style="font-weight:700">Choose pack size</label>`;
      const optionsBox = document.createElement('div'); optionsBox.className = 'option-list';
      allowed.forEach(q => {
        const opt = document.createElement('div'); opt.className='option'; opt.textContent = q; opt.dataset.q = q;
        opt.onclick = () => {
          optionsBox.querySelectorAll('.option').forEach(o=>o.classList.remove('active'));
          opt.classList.add('active');
          updatePrice();
        };
        optionsBox.appendChild(opt);
      });
      sizeWrap.appendChild(optionsBox);
      modalContent.appendChild(sizeWrap);

      // number of packs
      const qtyRow = document.createElement('div'); qtyRow.style.marginTop='12px';
      qtyRow.innerHTML = `<label style="font-weight:700">Number of packs</label>`;
      const num = document.createElement('input'); num.type='number'; num.min = 1; num.value = 1; num.style.marginTop='8px'; num.style.marginLeft='8px'; num.style.width='100px';
      qtyRow.appendChild(num);
      modalContent.appendChild(qtyRow);

      // display total price
      const totalDiv = document.createElement('div'); totalDiv.style.marginTop='14px'; totalDiv.style.fontWeight='800'; totalDiv.textContent = 'Total: —';
      modalContent.appendChild(totalDiv);

      // actions
      const actions = document.createElement('div'); actions.style.display='flex'; actions.style.justifyContent='flex-end'; actions.style.gap='10px'; actions.style.marginTop='16px';
      const cancel = document.createElement('button'); cancel.className='btn-alt'; cancel.textContent = 'Cancel';
      const add = document.createElement('button'); add.className='btn-choose'; add.textContent = 'Add to Cart';
      actions.appendChild(cancel); actions.appendChild(add);
      modalContent.appendChild(actions);

      // helpers
      function getSelectedSize(){ const a = optionsBox.querySelector('.option.active'); return a ? a.dataset.q : null; }
      function updatePrice(){
        const selSize = getSelectedSize();
        if(!selSize){ totalDiv.textContent = 'Total: —'; return; }
        const packs = Math.max(1, Number(num.value) || 1);
        const packPrice = pricePerPack(p, selSize);
        totalDiv.textContent = 'Total: ' + money(packPrice * packs);
      }

      // default select first option
      const firstOpt = optionsBox.querySelector('.option');
      if(firstOpt) { firstOpt.classList.add('active'); updatePrice(); }

      // events
      cancel.onclick = closeModal;
      num.oninput = updatePrice;
      add.onclick = () => {
        const selSize = getSelectedSize();
        if(!selSize){ alert('Please choose a pack size'); return; }
        const packs = Math.max(1, Number(num.value) || 1);
        const packPrice = pricePerPack(p, selSize);
        // item id includes product id + size to allow different pack sizes
        const itemId = `${p.id}::${selSize}`;
        // push item to cart (merge if same id)
        const existing = state.cart.find(i => i.id === itemId);
        if(existing){
          existing.packs += packs;
          existing.price += packPrice * packs;
        } else {
          state.cart.push({
            id: itemId,
            productId: p.id,
            title: p.title,
            variety: (p.varieties && p.varieties.length) ? (modalContent.querySelector('select') ? modalContent.querySelector('select').value : '') : '',
            size: selSize,
            packs: packs,
            price: packPrice * packs,
            img: p.img
          });
        }
        saveCart();
        closeModal();
      };

      // show modal
      modalBack.style.display = 'flex';
      modalBack.setAttribute('aria-hidden','false');
    }

    function closeModal(){
      modalBack.style.display = 'none';
      modalContent.innerHTML = '';
      modalBack.setAttribute('aria-hidden','true');
    }
    modalBack.addEventListener('click', (e)=>{ if(e.target === modalBack) closeModal(); });

    /*******************************
     * CART
     *******************************/
    const cartListEl = document.getElementById('cartList');
    const subtotalEl = document.getElementById('subtotal');
    const cartCountEl = document.getElementById('cartCount');
    const cartItemsCount = document.getElementById('cartItemsCount');
    const checkoutBtn = document.getElementById('checkoutBtn');

    function renderCart(){
      cartListEl.innerHTML = '';
      if(state.cart.length === 0){
        cartListEl.innerHTML = '<div class="muted">Your cart is empty</div>';
      } else {
        state.cart.forEach( (c, idx) => {
          const row = document.createElement('div'); row.className='cart-item';
          row.innerHTML = `
            <img src="${c.img || 'https://via.placeholder.com/160'}" alt="">
            <div class="meta">
              <b>${c.title}</b>
              <small>${c.variety ? c.variety + ' • ' : ''}${c.size} × ${c.packs}</small>
              <div style="margin-top:6px;font-weight:800">${money(c.price)}</div>
              <div class="qty-controls">
                <button class="small-btn" data-idx="${idx}" data-op="-">−</button>
                <div style="min-width:28px;text-align:center">${c.packs}</div>
                <button class="small-btn" data-idx="${idx}" data-op="+">+</button>
                <button class="small-btn" style="margin-left:8px;background:#fff;border:1px solid #f3f4f6" data-remove="${idx}">Remove</button>
              </div>
            </div>
          `;
          cartListEl.appendChild(row);
        });
      }
      const sub = state.cart.reduce((s,i)=>s + (i.price || 0), 0);
      subtotalEl.textContent = money(sub);
      cartCountEl.textContent = state.cart.reduce((s,i)=>s + i.packs, 0);
      cartItemsCount.textContent = state.cart.length;
      checkoutBtn.disabled = state.cart.length === 0;
    }

    // delegation for qty +/- and remove in cart
    cartListEl.addEventListener('click', (e) => {
      if(e.target.dataset.remove !== undefined){
        const idx = Number(e.target.dataset.remove);
        state.cart.splice(idx,1);
        saveCart();
        return;
      }
      const btn = e.target.closest('.small-btn');
      if(!btn) return;
      const idx = Number(btn.dataset.idx);
      const op = btn.dataset.op;
      if(isNaN(idx)) return;
      const entry = state.cart[idx];
      if(!entry) return;
      // find product to compute single pack price
      const prod = PRODUCTS.find(p=>p.id === entry.productId);
      if(!prod) return;
      const singlePackPrice = pricePerPack(prod, entry.size);
      if(op === '+'){ entry.packs += 1; entry.price += singlePackPrice; saveCart(); }
      if(op === '-') {
        if(entry.packs > 1){ entry.packs -= 1; entry.price -= singlePackPrice; saveCart(); }
        else { // remove if 1 -> 0
          if(confirm('Remove this item?')){ state.cart.splice(idx,1); saveCart(); }
        }
      }
    });

    // openCart scrolls to cart panel on small screens
    document.getElementById('openCart').addEventListener('click', ()=> { document.getElementById('cartPanel').scrollIntoView({behavior:'smooth'}); });

    function checkout(){
      if(state.cart.length === 0) return alert('Your cart is empty.');
      // placeholder summary
      let summ = 'Order Summary:\\n';
      state.cart.forEach(i=> summ += `${i.title} • ${i.size} × ${i.packs} — ${money(i.price)}\\n`);
      summ += '\\nSubtotal: ' + subtotalEl.textContent;
      alert('Checkout placeholder. Integrate payment gateway when ready.\\n\\n' + summ);
    }

    /*******************************
     * INIT
     *******************************/
    // Number is stored here and not displayed on the page
    const WHATSAPP_NUMBER = '919876543210'; 
    const contactSection = document.getElementById('contactSection');
    const headerContactBtn = document.getElementById('headerContactBtn');

    function init(){
      renderProducts();
      renderCart();
      document.getElementById('year').textContent = new Date().getFullYear();

      // Configure WhatsApp link
      const whatsappBtnLarge = document.getElementById('whatsappBtnLarge');

      if (whatsappBtnLarge) {
        // Pre-filled message for better user experience
        const message = encodeURIComponent('Hello, I am interested in BrahminBazaar products. Can you help me with my order?');
        const href = `https://wa.me/${WHATSAPP_NUMBER}?text=${message}`;
        whatsappBtnLarge.href = href;
      }
      
      // Contact Us button handler - scrolls to the new bottom section
      if(headerContactBtn) {
          headerContactBtn.addEventListener('click', () => {
              if (contactSection) {
                  // Scroll to the contact section
                  contactSection.scrollIntoView({behavior: 'smooth'});
              }
          });
      }

      // keyboard Enter triggers search
      searchEl.addEventListener('keydown', (e)=> { if(e.key === 'Enter') renderProducts(); });
    }

    init();

    // autosave cart to localStorage when changed
    window.addEventListener('beforeunload', saveCart);

  </script>
</body>
</html>