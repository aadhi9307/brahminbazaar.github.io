<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BrahminBazaar — Vyaasa Trade & Logistix LLP</title>
  <meta name="description" content="BrahminBazaar - fresh staples, spices, oils and more."/>
  <style>
    :root{
      --primary-dark:#00796b; --primary:#009688; --primary-light:#4db6ac;
      --bg:#f8faf9; --card:#ffffff; --text:#1a1a1a; --muted:#6b7280;
      --shadow:0 10px 25px rgba(0,0,0,.06); --radius:14px; --max:1200px;
      --ink:#0a3e38; --ink-2:#0f5b53;
      --footer:#0c1b1a; --footer-ink:#d9f5f0;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html, body { height:100%; }
    body{min-height:100%; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;}
    .page{min-height:100vh; display:flex; flex-direction:column;}
    main{flex:1;}

    /* Header (taller) */
    header{background:var(--card);position:sticky;top:0;z-index:60}
    .wrap{
      max-width:var(--max);margin:0 auto;
      padding:18px 18px; /* taller */
      display:grid;grid-template-columns:auto 1fr auto;gap:16px;align-items:center
    }
    .brand{display:flex;gap:14px;align-items:center}
    .logo{width:48px;height:48px;border-radius:12px;overflow:hidden;border:1px solid #e6f0ef;background:#f6fbfa;display:flex;align-items:center;justify-content:center}
    .logo img{width:100%;height:100%;object-fit:cover}
    .brand h1{font-size:1.32rem;font-weight:800;color:var(--primary-dark);line-height:1}
    .tag{font-size:12px;color:var(--muted);margin-top:4px}

    /* Header middle: search (smaller than previous), sort */
    .header-tools{display:flex;gap:12px;align-items:center;justify-content:flex-end}
    .search{background:#fff;border:1px solid #e3eeed;padding:10px 12px;border-radius:12px;display:flex;gap:8px;align-items:center;box-shadow:var(--shadow);width:100%;max-width:480px}
    .search input{flex:1;border:none;outline:none;font-size:15px}
    .sort{display:flex;gap:8px;align-items:center}
    .sort select{padding:10px 12px;border-radius:10px;border:1px solid #e1ece9;background:#fff;cursor:pointer}

    /* Header right: icon buttons with labels */
    .controls{display:flex;gap:14px;align-items:end;justify-content:flex-end}
    .icon-stack{display:flex;flex-direction:column;align-items:center;gap:4px;min-width:48px}
    .icon-btn{
      width:44px;height:44px;border-radius:12px;border:1px solid #d9ece8;background:#eef9f7;color:#095b53;
      display:inline-flex;align-items:center;justify-content:center;cursor:pointer;position:relative
    }
    .icon-btn:hover{background:#e3f3f1}
    .label{font-size:10.5px;color:var(--muted);font-weight:700;letter-spacing:.2px}
    .badge{
      position:absolute;top:-6px;right:-6px;min-width:18px;height:18px;border-radius:999px;
      background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff;
      display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;padding:0 4px;box-shadow:0 6px 12px rgba(0,0,0,.18)
    }

    /* Thin teal line */
    .header-accent{height:2px;background:var(--primary);}

    /* Greeting block under header (left) */
    .subtitle{max-width:var(--max);margin:12px auto 0;padding:0 18px;color:var(--ink-2);}
    .subtitle .big{font-weight:800;font-size:1.22rem}
    .subtitle .helper{display:block;color:var(--muted);font-weight:600;margin-top:4px;max-width:560px}

    /* Main layout — wider cart for neat fit */
    main{max-width:var(--max);margin:12px auto 24px;display:grid;grid-template-columns:1fr 420px;gap:24px;padding:0 18px}
    @media (max-width:980px){ main{grid-template-columns:1fr} }

    /* Category chips */
    .toolbar{display:flex;gap:14px;align-items:center;margin:10px 0}
    .chips{display:flex;gap:10px;flex-wrap:wrap}
    .chip{
      background:#e8f5f4;color:#075e55;border:1px solid #cfe9e6;
      padding:10px 16px;border-radius:999px;font-weight:800;font-size:14.5px;cursor:pointer
    }
    .chip.active{background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff;border:none;box-shadow:0 18px 38px rgba(0,150,136,.25)}
    .counts{color:var(--muted);font-size:12px;margin-left:auto}
    .no-results{display:none;border:1px dashed rgba(0,150,136,.18);background:linear-gradient(180deg,#fff,#fcfffe);padding:16px;border-radius:12px;color:#0a5d55;font-weight:700}

    /* Product cards */
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:18px}
    @media (max-width:1100px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--card);border-radius:16px;padding:14px;box-shadow:var(--shadow);display:flex;gap:14px;align-items:flex-start;border:1px solid #eef2f1;transition:transform .15s}
    .card:hover{transform:translateY(-5px)}
    .media{width:190px;height:140px;border-radius:12px;overflow:hidden;background:#f6faf6;display:flex;align-items:center;justify-content:center}
    .media img{width:100%;height:100%;object-fit:cover}
    .info{flex:1}
    .info h3{margin:0 0 6px;color:var(--text);font-size:1.05rem}
    .meta{color:var(--muted);font-size:13px}
    .price{font-weight:800;color:var(--primary-dark);margin-top:8px}

    .actions{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap}
    .btn-primary{background:var(--primary-dark);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer;box-shadow:0 8px 20px rgba(0,150,136,.22)}
    .btn-ghost{background:#fff;border:1px solid #dfeae8;color:#0a5d55;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer;}
    .start-size{margin-left:auto;color:var(--muted);font-size:12px}

    /* Cart (wider + adjusted sticky offset for taller header) */
    .cart{background:var(--card);border-radius:12px;padding:16px;position:sticky;top:98px;height:fit-content;box-shadow:0 10px 30px rgba(10,20,18,.08);border:1px solid #e6efed}
    .cart h3{margin:0 0 10px}
    .cart-list{display:flex;flex-direction:column;gap:12px;max-height:460px;overflow:auto;padding-right:6px}
    .cart-item{display:flex;gap:12px;align-items:center}
    .cart-item img{width:64px;height:64px;border-radius:8px;object-fit:cover}
    .cart-item .meta{flex:1}
    .small-btn{padding:6px 10px;border-radius:8px;border:1px solid #e6efed;background:#f7fbfa;cursor:pointer}
    .cart-total{margin-top:10px;display:flex;justify-content:space-between;align-items:center;font-weight:800;color:#0b5f57}
    .checkout{width:100%;margin-top:12px;background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff;border:none;padding:12px;border-radius:10px;font-weight:800;cursor:pointer;box-shadow:0 12px 32px rgba(0,150,136,.35)}

    /* Modals */
    .modal-back{position:fixed;inset:0;background:rgba(4,6,8,.45);display:none;align-items:center;justify-content:center;z-index:120}
    .modal{background:#fff;padding:20px;border-radius:16px;max-width:760px;width:96%;box-shadow:0 20px 40px rgba(12,18,20,.28)}
    .option-list{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .option{padding:8px 10px;border-radius:10px;border:1px solid #e7efee;background:#fff;cursor:pointer}
    .option.active{border-color:var(--primary);box-shadow:0 12px 30px rgba(0,150,136,.08)}

    /* Account modal */
    #authBack{display:none}
    #authBack .modal{max-width:820px}
    #authBack label{display:block;margin-bottom:6px;font-weight:700;color:#0a5d55}
    #authBack input,#authBack textarea{padding:14px 16px;border:1px solid #e1ece9;border-radius:12px;font-size:15px}
    #authBack .row{display:flex;gap:18px;flex-wrap:wrap;margin-top:14px}
    #authBack .row > div{flex:1}

    /* WhatsApp strip + footer */
    .wh-strip{max-width:var(--max);margin:26px auto 40px; padding:0 18px}
    .wh-box{
      background:linear-gradient(180deg,#072a27,#0e3c37);
      border:1px solid #124a44;color:#dff8f2;border-radius:14px;padding:16px;display:flex;align-items:center;justify-content:space-between;gap:10px;
      box-shadow:0 18px 38px rgba(0,0,0,.25)
    }
    .wh-actions{display:flex;gap:10px;flex-wrap:wrap}
    .wh-btn{ text-decoration:none;display:inline-block;border-radius:10px;padding:10px 14px;font-weight:800;border:1px solid #2a6f66;background:#0f5b53;color:#e9fffb }
    .wh-btn.alt{background:#124a44;border-color:#1f5a52}

    footer{background:var(--footer);color:var(--footer-ink)}
    .foot{max-width:var(--max);margin:0 auto;padding:28px 18px;display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .foot .small{font-size:.9rem;opacity:.9}
    .foot-right{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
    .foot a.admin{font-size:.8rem;text-transform:lowercase;color:#9de8dc;text-decoration:none;opacity:.9}
    .foot a.admin:hover{opacity:1;text-decoration:underline}
    .designer{font-size:.85rem;opacity:.9}
  </style>
</head>
<body>
<div class="page">
  <!-- Header -->
  <header>
    <div class="wrap">
      <!-- Left: brand -->
      <div class="brand">
        <div class="logo"><img src="logo.png" alt="BrahminBazaar"></div>
        <div>
          <h1>BrahminBazaar</h1>
          <div class="tag">Restoring Traditions...</div>
        </div>
      </div>

      <!-- Middle: search + sort -->
      <div class="header-tools">
        <div class="search" role="search" aria-label="Search products">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="11" cy="11" r="6" stroke="#333" stroke-width="2"/><path d="M20 20l-3.5-3.5" stroke="#333" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="search" placeholder="Search rice, dals, spices…" />
        </div>
        <div class="sort">
          <label for="sort" style="color:var(--muted);font-size:14px">Sort</label>
          <select id="sort">
            <option value="recommended">Recommended</option>
            <option value="price-asc">Price: Low→High</option>
            <option value="price-desc">Price: High→Low</option>
            <option value="alpha-asc">A→Z</option>
            <option value="alpha-desc">Z→A</option>
          </select>
        </div>
      </div>

      <!-- Right: square icon buttons with labels -->
      <div class="controls">
        <div class="icon-stack">
          <button class="icon-btn" id="btnAccount" title="Account" aria-label="Account">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
          </button>
          <div class="label">account</div>
        </div>
        <div class="icon-stack">
          <button class="icon-btn" id="openCart" title="Cart" aria-label="Cart">
            <span class="badge" id="cartBadge">0</span>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="9" cy="21" r="1"></circle>
              <circle cx="20" cy="21" r="1"></circle>
              <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h7.72a2 2 0 0 0 2-1.61L21 6H6"/>
            </svg>
          </button>
          <div class="label">cart</div>
        </div>
        <div class="icon-stack">
          <button class="icon-btn" id="toContact" title="Contact us" aria-label="Contact">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.79 19.79 0 0 1 2.08 4.18 2 2 0 0 1 4.06 2h3a2 2 0 0 1 2 1.72 12.66 12.66 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.66 12.66 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
            </svg>
          </button>
          <div class="label">help</div>
        </div>
      </div>
    </div>
  </header>
  <div class="header-accent"></div>

  <!-- Greeting text below header -->
  <div class="subtitle">
    <div class="big" id="greet">Welcome Back! Ready to stock up on your essentials?</div>
    <small class="helper">Click a category to filter. Click a product to choose variety & quantity.</small>
  </div>

  <!-- Main -->
  <main>
    <section>
      <div class="toolbar">
        <div class="chips" id="chips"></div>
        <div class="counts"><span id="count"></span></div>
      </div>
      <div id="noResults" class="no-results">No products found for your search.</div>
      <div class="grid" id="grid" aria-live="polite"></div>
    </section>

    <!-- Cart -->
    <aside class="cart" aria-label="Cart">
      <h3>Your Cart</h3>
      <div id="cartList" class="cart-list"></div>
      <div class="cart-total"><span>Total</span> <span id="cartTotal">₹0.00</span></div>
      <button class="checkout" id="checkoutBtn">Checkout</button>
    </aside>
  </main>

  <!-- WhatsApp strip (contact section) -->
  <div class="wh-strip" id="contact">
    <div class="wh-box">
      <div>
        <div style="font-weight:800">Need help or want to partner with us?</div>
        <div style="opacity:.85;font-size:13px;margin-top:2px">Chat with our team on WhatsApp.</div>
      </div>
      <div class="wh-actions">
        <a class="wh-btn" target="_blank" rel="noopener" href="https://wa.me/917093960001?text=Hi%20BrahminBazaar%2C%20I%20need%20help%20with%20my%20order.">Contact Us</a>
        <a class="wh-btn alt" target="_blank" rel="noopener" href="https://wa.me/917093960001?text=Hello%20BrahminBazaar%2C%20I%20want%20to%20register%20as%20a%20seller.%20Please%20share%20the%20next%20steps.">Register as Seller</a>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <div class="foot">
      <div class="small">© <span id="year"></span> VYTAL. All rights reserved.</div>
      <div class="foot-right">
        <a class="admin" href="admin	.html" aria-label="Open Admin Panel">admin</a>
        <div class="designer">Designed by Sundar Rajan Aathreya</div>
      </div>
    </div>
  </footer>
</div>

  <!-- Product modal -->
  <div id="modalBack" class="modal-back" role="dialog" aria-modal="true">
    <div class="modal" id="modalContent"></div>
  </div>

  <!-- Account modal -->
  <div id="authBack" class="modal-back">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <h3 id="authTitle" style="color:var(--primary-dark)">Create Account</h3>
      <form id="formCreate">
        <div class="row">
          <div>
            <label>Full Name</label>
            <input id="c_name" required/>
          </div>
          <div>
            <label>Phone</label>
            <input id="c_phone" type="tel" placeholder="10 digits" required/>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Email</label>
            <input id="c_email" type="email" required/>
          </div>
          <div>
            <label>Password</label>
            <input id="c_pass" type="password" minlength="4" required/>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Address</label>
            <textarea id="c_addr" rows="3" required></textarea>
          </div>
        </div>
        <div class="row" style="justify-content:flex-end">
          <button type="button" class="btn-ghost" id="toLogin">Already existing user</button>
          <button type="submit" class="btn-primary">Create Account</button>
        </div>
      </form>

      <form id="formLogin" style="display:none">
        <div class="row">
          <div>
            <label>Email or Phone</label>
            <input id="l_id" required/>
          </div>
          <div>
            <label>Password</label>
            <input id="l_pass" type="password" required/>
          </div>
        </div>
        <div class="row" style="justify-content:flex-end">
          <button type="button" class="btn-ghost" id="toCreate">New user? Create account</button>
          <button type="submit" class="btn-primary">Login</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    /*************** KEYS ***************/
    const PRODUCTS_KEY = 'brahminbazaar_admin_products';
    const ACCOUNTS_KEY = 'bb_accounts_v1';
    const SESSION_KEY  = 'bb_user_v1';
    const ORDERS_KEY   = 'brahminbazaar_orders';

    /*************** ELEMENTS ***************/
    const chipsEl = document.getElementById('chips');
    const grid = document.getElementById('grid');
    const countEl = document.getElementById('count');
    const noResults = document.getElementById('noResults');
    const searchEl = document.getElementById('search');
    const sortEl = document.getElementById('sort');
    const cartList = document.getElementById('cartList');
    const cartTotal = document.getElementById('cartTotal');
    const cartBadge = document.getElementById('cartBadge');
    const modalBack = document.getElementById('modalBack');
    const modalContent = document.getElementById('modalContent');
    const authBack = document.getElementById('authBack');
    const greetEl = document.getElementById('greet');
    document.getElementById('year').textContent = new Date().getFullYear();

    // Header contact scroll
    document.getElementById('toContact').onclick = (e)=>{
      e.preventDefault();
      document.getElementById('contact').scrollIntoView({ behavior:'smooth', block:'start' });
    };

    // Account icon -> login/logout
    document.getElementById('btnAccount').onclick = ()=>{
      loadSession();
      if(SESSION){
        if(confirm(`Logged in as ${SESSION.name||'(no name)'}.\nLog out?`)){
          SESSION=null; saveSession(); alert('Logged out.');
          CART=[]; renderCart(); renderGreeting();
        }
      }else{
        toggleAuth(true);
      }
    };

    /*************** DATA ***************/
    let PRODUCTS = [
      {id:'rice-sona',category:'Rice',title:'Sona Masoori',basePrice:60,img:'https://via.placeholder.com/400x300?text=Sona+Masoori',varieties:['Raw','Steam','Parboiled']},
      {id:'rice-ponni',category:'Rice',title:'Ponni Rice',basePrice:55,img:'https://via.placeholder.com/400x300?text=Ponni+Rice',varieties:['Raw','Steamed']},
      {id:'rice-basmati',category:'Rice',title:'Basmati',basePrice:170,img:'https://via.placeholder.com/400x300?text=Basmati',varieties:['Standard','Aged']},
      {id:'dal-toor',category:'Dals',title:'Toor Dal',basePrice:140,img:'https://via.placeholder.com/400x300?text=Toor+Dal'},
      {id:'sp-turmeric',category:'Spices',title:'Turmeric Powder',basePrice:300,img:'https://via.placeholder.com/400x300?text=Turmeric'},
      {id:'oil-gingelly',category:'Oils',title:'Gingelly (Sesame) Oil',basePrice:420,img:'https://via.placeholder.com/400x300?text=Gingelly+Oil',oil:true},
      {id:'oil-coconut',category:'Oils',title:'Coconut Oil',basePrice:260,img:'https://via.placeholder.com/400x300?text=Coconut+Oil',oil:true},
      {id:'salt-pink',category:'Salts',title:'Himalayan Pink Salt',basePrice:40,img:'https://via.placeholder.com/400x300?text=Pink+Salt'},
      {id:'flour-wheat',category:'Flours',title:'Wheat Flour (Atta)',basePrice:35,img:'https://via.placeholder.com/400x300?text=Wheat+Flour'},
      {id:'bev-coffee',category:'Beverages',title:'Coffee Powder',basePrice:450,img:'https://via.placeholder.com/400x300?text=Coffee'}
    ];
    (function readAdminCatalog(){
      try {
        const raw = localStorage.getItem(PRODUCTS_KEY);
        const list = raw ? JSON.parse(raw) : null;
        if(Array.isArray(list) && list.length) PRODUCTS = list;
      } catch {}
    })();

    const QUANTITIES = {
      'Rice': ['225g','450g','1kg','2kg','5kg','25kg'],
      'Dals': ['225g','450g','1kg','2kg','5kg'],
      'Spices': ['225g','450g','1kg'],
      'Oils': ['225ml','450ml','1L','2L','5L'],
      'Salts': ['225g','450g','1kg'],
      'Flours': ['225g','450g','1kg','2kg','5kg'],
      'Millets': ['225g','450g','1kg','2kg'],
      'Other Grains': ['225g','450g','1kg','2kg'],
      'Beverages': ['225g','450g','1kg'],
      'All': ['225g','450g','1kg','2kg','5kg']
    };

    /*************** ACCOUNTS & SESSION ***************/
    let ACCOUNTS = {}; let SESSION = null;
    function loadAccounts(){ try{ ACCOUNTS = JSON.parse(localStorage.getItem(ACCOUNTS_KEY) || '{}'); }catch{ ACCOUNTS = {}; } }
    function saveAccounts(){ localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(ACCOUNTS)); }
    function loadSession(){ try{ SESSION = JSON.parse(localStorage.getItem(SESSION_KEY) || 'null'); }catch{ SESSION = null; } }
    function saveSession(){ if(SESSION) localStorage.setItem(SESSION_KEY, JSON.stringify(SESSION)); else localStorage.removeItem(SESSION_KEY); }
    function accountKey(){ return SESSION?.email || SESSION?.phone || null; }
    function accountObj(){ const k=accountKey(); return k? ACCOUNTS[k] : null; }
    function ensureFields(o){ o.recentSearches ||= []; o.cart ||= []; return o; }
    function saveAcc(edit){ const k=accountKey(); if(!k) return; const base=ensureFields(ACCOUNTS[k]); edit(base); ACCOUNTS[k]=base; saveAccounts(); SESSION.name=base.name; SESSION.address=base.address; saveSession(); renderCart(); }

    /*************** STATE ***************/
    let CART = [];
    function loadCart(){
      loadAccounts(); loadSession();
      const acc = accountObj();
      if(acc && Array.isArray(acc.cart)) { CART = acc.cart; return; }
      try{ CART = JSON.parse(localStorage.getItem('brahminbazaar_cart_v2')||'[]'); }catch{ CART=[]; }
    }
    loadCart();

    const money = n => '₹' + Number(n).toFixed(2);

    /*************** GREETING ***************/
    function renderGreeting(){
      loadSession();
      if(SESSION && (SESSION.name || SESSION.email || SESSION.phone)){
        greetEl.textContent = 'Namaste ' + SESSION.name + '! Welcome Back! Ready to stock up on your essentials?';
      }else{
        greetEl.textContent = 'Welcome! Ready to stock up on your essentials?';
      }
    }

    /*************** RENDER ***************/
    function categories(){ return [...new Set(PRODUCTS.map(p=>p.category))].sort(); }

    function renderChips(active='All'){
      chipsEl.innerHTML='';
      const add = (name)=>{
        const b=document.createElement('button'); b.className='chip'; b.textContent=name;
        if(name===active) b.classList.add('active');
        b.onclick=()=>{ renderList(name, (searchEl.value||'').trim().toLowerCase(), sortEl.value); renderChips(name); };
        chipsEl.appendChild(b);
      };
      add('All'); categories().forEach(add);
    }

    function renderList(category='All', q='', sort='recommended'){
      const list = PRODUCTS
        .filter(p=>{
          if(category!=='All' && p.category!==category) return false;
          if(q){
            const hay=(p.title+' '+(p.varieties||[]).join(' ')+' '+p.category+' '+p.id).toLowerCase();
            if(!hay.includes(q)) return false;
          }
          return true;
        })
        .sort((a,b)=>{
          if(sort==='price-asc') return a.basePrice - b.basePrice;
          if(sort==='price-desc') return b.basePrice - a.basePrice;
          if(sort==='alpha-asc') return a.title.localeCompare(b.title);
          if(sort==='alpha-desc') return b.title.localeCompare(a.title);
          return 0; // recommended
        });

      grid.innerHTML='';
      if(list.length===0){ noResults.style.display='block'; } else { noResults.style.display='none'; }
      list.forEach(p=>{
        const card=document.createElement('article'); card.className='card';
        card.innerHTML=`
          <div class="media"><img src="${p.img}" alt="${p.title}"></div>
          <div class="info">
            <h3>${p.title}</h3>
            <div class="meta">${p.category}</div>
            <div class="price">${p.oil? money(p.basePrice)+' / L': money(p.basePrice)+' / kg'}</div>
            <div class="actions">
              <button class="btn-primary" data-id="${p.id}" data-act="choose">Choose & Add</button>
              <button class="btn-ghost" data-id="${p.id}" data-act="details">Details</button>
              <div class="start-size">Start ${p.oil?'225ml':'225g'}</div>
            </div>
          </div>`;
        grid.appendChild(card);
      });
      countEl.textContent = `${list.length} items`;
      grid.querySelectorAll('button[data-act]').forEach(btn=>{
        const id = btn.dataset.id; const act = btn.dataset.act;
        btn.onclick = ()=> openProductModal(id, act==='details');
      });
    }

    function openProductModal(id, detailsOnly=false){
      const p = PRODUCTS.find(x=>x.id===id); if(!p) return;
      const allowed = QUANTITIES[p.category] || QUANTITIES['All'];
      modalContent.innerHTML='';
      const top=document.createElement('div');
      top.innerHTML=`
        <div style="display:flex;gap:14px;align-items:center">
          <div style="width:150px;height:110px;border-radius:10px;overflow:hidden;background:#f6faf6;flex-shrink:0">
            <img src="${p.img}" alt="${p.title}" style="width:100%;height:100%;object-fit:cover">
          </div>
          <div>
            <h3 style="margin:0">${p.title}</h3>
            <div class="meta" style="margin-top:6px">${p.category} • ${p.oil? money(p.basePrice)+' / L': money(p.basePrice)+' / kg'}</div>
            <div style="margin-top:8px;font-size:13px;color:var(--muted)">Choose variety (if any) and a pack size, then add packs.</div>
          </div>
        </div>`;
      modalContent.appendChild(top);

      if(p.varieties && p.varieties.length){
        const v=document.createElement('div'); v.style.marginTop='12px'; v.innerHTML=`<label style="font-weight:700">Variety</label>`;
        const sel=document.createElement('select'); sel.style.marginTop='8px';
        p.varieties.forEach(vv=>{ const o=document.createElement('option'); o.value=vv; o.textContent=vv; sel.appendChild(o); });
        v.appendChild(sel); modalContent.appendChild(v);
      }

      const sizeWrap=document.createElement('div'); sizeWrap.style.marginTop='12px';
      sizeWrap.innerHTML=`<label style="font-weight:700">Pack Size</label>`;
      const options=document.createElement('div'); options.className='option-list';
      (p.oil? ['225ml','450ml','1L','2L','5L'] : ['225g','450g','1kg','2kg','5kg']).forEach(q=>{
        if(allowed && allowed.indexOf(q)===-1) return;
        const a=document.createElement('div'); a.className='option'; a.textContent=q; a.dataset.q=q;
        a.onclick=()=>{ options.querySelectorAll('.option').forEach(x=>x.classList.remove('active')); a.classList.add('active'); updateTotal(); };
        options.appendChild(a);
      });
      sizeWrap.appendChild(options); modalContent.appendChild(sizeWrap);

      const packsBox=document.createElement('div'); packsBox.style.marginTop='12px';
      packsBox.innerHTML=`<label style="font-weight:700">Number of packs</label><br>
        <input id="packs" type="number" value="1" min="1" style="margin-top:6px;width:140px;padding:10px 12px;border:1px solid #e1ece9;border-radius:12px">`;
      modalContent.appendChild(packsBox);
      const packsInp = packsBox.querySelector('#packs');

      const totalLine=document.createElement('div'); totalLine.style.cssText='margin-top:10px;text-align:right;font-weight:800';
      totalLine.textContent='Total: —'; modalContent.appendChild(totalLine);

      const actions=document.createElement('div'); actions.style.cssText='display:flex;justify-content:flex-end;gap:10px;margin-top:16px';
      const cancel=document.createElement('button'); cancel.className='btn-ghost'; cancel.textContent='Close';
      const add=document.createElement('button'); add.className='btn-primary'; add.textContent='Add to Cart';
      actions.appendChild(cancel); if(!detailsOnly) actions.appendChild(add); modalContent.appendChild(actions);

      function selectedSize(){ const a=options.querySelector('.option.active'); return a? a.dataset.q: null; }
      function unitPrice(){
        const s=selectedSize(); if(!s) return 0;
        let factor=1; if(!p.oil){
          if(s.endsWith('kg')) factor=parseFloat(s);
          else if(s.endsWith('g')) factor=parseFloat(s)/1000;
        } else {
          if(s.endsWith('L')) factor=parseFloat(s);
          else if(s.endsWith('ml')) factor=parseFloat(s)/1000;
        }
        return (Number(p.basePrice)||0)*factor;
      }
      function updateTotal(){
        const s=selectedSize(); const n=Math.max(1, Number(packsInp.value)||1);
        totalLine.textContent = s ? ('Total: '+money(unitPrice()*n)) : 'Total: —';
      }

      const first=options.querySelector('.option'); if(first){ first.classList.add('active'); updateTotal(); }
      packsInp.oninput=updateTotal;

      cancel.onclick=()=>{ modalBack.style.display='none'; document.body.style.overflow='auto'; };
      add.onclick=()=>{
        if(!SESSION){ toggleAuth(true); return; }
        const s=selectedSize(); if(!s) return alert('Choose a pack size');
        const n=Math.max(1, Number(packsInp.value)||1);
        const variety=(modalContent.querySelector('select')||{}).value||null;
        const price = unitPrice()*n;

        CART.push({ id:p.id,title:p.title,size:s,packs:n,variety,price,oil:!!p.oil,img:p.img });
        saveCart();
        modalBack.style.display='none'; document.body.style.overflow='auto';
        document.getElementById('openCart').click();
      };

      modalBack.style.display='flex'; document.body.style.overflow='hidden';
    }

    function renderCart(){
      cartList.innerHTML='';
      if(CART.length===0){
        cartList.innerHTML='<div style="padding:20px;border:1px dashed #e3efed;border-radius:10px;text-align:center;color:#0b5f57">Your cart is empty.</div>';
        cartTotal.textContent='₹0.00'; cartBadge.textContent='0'; return;
      }
      let total=0;
      CART.forEach((c,i)=>{
        total += Number(c.price)||0;
        const row=document.createElement('div'); row.className='cart-item';
        row.innerHTML=`
          <img src="${c.img||'https://via.placeholder.com/160'}" alt="">
          <div class="meta">
            <b>${c.title}</b>
            <small>${c.variety? c.variety+' • ' : ''}${c.size} × ${c.packs}</small>
            <div style="margin-top:6px;font-weight:800">${money(c.price)}</div>
            <div class="qty">
              <button class="small-btn" data-i="${i}" data-op="-">−</button>
              <div style="min-width:28px;text-align:center">${c.packs}</div>
              <button class="small-btn" data-i="${i}" data-op="+">+</button>
              <button class="small-btn" style="margin-left:8px;background:#fff;border:1px solid #f3f4f6" data-rm="${i}">Remove</button>
            </div>
          </div>`;
        cartList.appendChild(row);
      });
      cartTotal.textContent = money(total);
      cartBadge.textContent = String(CART.length);
      // qty events
      cartList.querySelectorAll('button[data-i]').forEach(b=>{
        b.onclick=()=>{
          const i=+b.dataset.i; const op=b.dataset.op; const it=CART[i]; if(!it) return;
          if(op==='+'){ it.packs+=1; it.price = (it.price/ (it.packs-1)) * it.packs; }
          else { it.packs=Math.max(0,it.packs-1); if(it.packs===0) CART.splice(i,1); else it.price = (it.price/(it.packs+1))*it.packs; }
          saveCart();
        };
      });
      cartList.querySelectorAll('button[data-rm]').forEach(b=>{
        b.onclick=()=>{ const i=+b.dataset.rm; CART.splice(i,1); saveCart(); };
      });
    }

    function saveCart(){
      if(SESSION){ saveAcc(a=>{ a.cart=CART; }); }
      else { localStorage.setItem('brahminbazaar_cart_v2', JSON.stringify(CART)); renderCart(); }
      renderCart();
    }

    /*************** SEARCH & SORT ***************/
    searchEl.oninput = ()=>{
      const q=(searchEl.value||'').trim().toLowerCase();
      if(SESSION && q){ saveAcc(a=>{ a.recentSearches=[q,...(a.recentSearches||[])].slice(0,10); }); }
      const active = (chipsEl.querySelector('.chip.active')||{}).textContent || 'All';
      renderList(active, q, sortEl.value);
    };
    sortEl.onchange = ()=>{
      const active = (chipsEl.querySelector('.chip.active')||{}).textContent || 'All';
      renderList(active, (searchEl.value||'').trim().toLowerCase(), sortEl.value);
    };

    /*************** AUTH ***************/
    function toggleAuth(show){ authBack.style.display = show ? 'flex' : 'none'; }
    authBack.addEventListener('click',(e)=>{ if(e.target===authBack) toggleAuth(false); });

    document.getElementById('toLogin')?.addEventListener('click',()=>{
      document.getElementById('formCreate').style.display='none';
      document.getElementById('formLogin').style.display='block';
      document.getElementById('authTitle').textContent='Login';
    });
    document.getElementById('toCreate')?.addEventListener('click',()=>{
      document.getElementById('formLogin').style.display='none';
      document.getElementById('formCreate').style.display='block';
      document.getElementById('authTitle').textContent='Create Account';
    });

    document.getElementById('formCreate').onsubmit=(e)=>{
      e.preventDefault(); loadAccounts();
      const name=document.getElementById('c_name').value.trim();
      const email=document.getElementById('c_email').value.trim().toLowerCase();
      const phone=document.getElementById('c_phone').value.trim();
      const pass=document.getElementById('c_pass').value;
      const addr=document.getElementById('c_addr').value.trim();
      if(!/^\d{10}$/.test(phone)) return alert('Enter 10-digit phone');
      const key=email||phone; if(ACCOUNTS[key]) return alert('Account already exists');
      ACCOUNTS[key]={ name,email,phone,address:addr,pass,recentSearches:[],cart:[] }; saveAccounts();
      SESSION={ name,email,phone,address:addr }; saveSession();
      toggleAuth(false); alert('Account created & logged in.');
      CART = []; saveCart(); renderGreeting();
    };

    document.getElementById('formLogin').onsubmit=(e)=>{
      e.preventDefault(); loadAccounts();
      const id=document.getElementById('l_id').value.trim().toLowerCase();
      const pwd=document.getElementById('l_pass').value;
      const acc=ACCOUNTS[id];
      if(!acc || acc.pass!==pwd) return alert('Invalid credentials');
      SESSION={ name:acc.name,email:acc.email,phone:acc.phone,address:acc.address }; saveSession();
      toggleAuth(false); alert('Logged in.'); CART=acc.cart||[]; renderCart(); renderGreeting();
    };

    /*************** CART BUTTON ***************/
    document.getElementById('openCart').onclick=()=> renderCart();

    /*************** SYNC WITH ADMIN ***************/
    const CH = ('BroadcastChannel' in window)? new BroadcastChannel('bb_sync') : null;
    window.BB_RELOAD_CATALOG = (list)=>{ PRODUCTS=list; const active=(chipsEl.querySelector('.chip.active')||{}).textContent||'All'; renderChips(active); renderList(active,(searchEl.value||'').trim().toLowerCase(),sortEl.value); };
    window.addEventListener('storage',(e)=>{ if(e.key===PRODUCTS_KEY){ try{ PRODUCTS=JSON.parse(localStorage.getItem(PRODUCTS_KEY)||'[]')||PRODUCTS; }catch{} BB_RELOAD_CATALOG(PRODUCTS); } });
    CH && (CH.onmessage=(m)=>{ if(m?.data?.type==='catalog-updated'){ try{ PRODUCTS=JSON.parse(localStorage.getItem(PRODUCTS_KEY)||'[]')||PRODUCTS; }catch{} BB_RELOAD_CATALOG(PRODUCTS); } });

    /*************** INIT ***************/
    function init(){
      renderGreeting();
      renderChips('All');
      document.getElementById('sort').value = 'recommended';
      renderList('All','','recommended');
      renderCart();
    }
    init();
  </script>
  <!-- === DB WIRE (BUYER) — paste above </body> === -->
<script>
    /*******************************
     * CONFIGURATION & CONSTANTS
     *******************************/
    // !!! CRITICAL: UPDATE THIS WITH YOUR LIVE SERVER URL !!!
    // If your server is on a different domain than brahminbazaar.com (e.g., render.com), use that URL.
    const API_BASE_URL = 'https://brahminbazaar.com/api'; // Ensure quotes are present: ''
    const WHATSAPP_NUMBER = '919876543210'; 
    
    // Global data arrays (populated from API)
    let PRODUCTS = [];
    let CART = []; 
    let SESSION = null; // Stores logged-in user data
    let currentProduct = null; 

    // DOM Elements (Ensure these IDs exist in your HTML)
    const productsGridEl = document.getElementById('productsGrid');
    const chipsEl = document.getElementById('categoryChips');
    const searchEl = document.getElementById('search');
    const sortEl = document.getElementById('sort');
    const cartCountEl = document.getElementById('cartCount');
    const productCountTextEl = document.getElementById('productCountText');
    const cartListEl = document.getElementById('cartList');
    const subtotalEl = document.getElementById('subtotal');
    const cartItemsCountEl = document.getElementById('cartItemsCount');
    const checkoutBtnEl = document.getElementById('checkoutBtn');
    const contactSection = document.getElementById('contactSection');
    const headerContactBtn = document.getElementById('headerContactBtn');
    const greetingEl = document.getElementById('greeting');
    const authLink = document.getElementById('authLink');
    const logoutLink = document.getElementById('logoutLink');
    const authForm = document.getElementById('authForm');
    const sellerRegForm = document.getElementById('sellerRegForm');

    // --- UTILITIES ---
    function money(n){ return Number(n).toFixed(2); }
    
    function saveSession() { 
        if(SESSION && SESSION.id) {
            SESSION.cart = CART; // Update cart in session before saving locally
            localStorage.setItem('BB_Session', JSON.stringify(SESSION));
            // CRUCIAL: Sync cart to DB whenever session cart is modified
            syncCartToDatabase(); 
        } else {
            localStorage.removeItem('BB_Session');
        }
    }

    // --- API CALLS: Data Synchronization ---
    async function fetchProducts() {
        try {
            const response = await fetch(`${API_BASE_URL}/products`);
            if (!response.ok) throw new Error('Failed to fetch products');
            PRODUCTS = await response.json();
            
            const activeChip = (chipsEl.querySelector('.chip.active') || {}).textContent || 'All';
            renderChips(activeChip); 
            renderList(activeChip, (searchEl.value || '').trim().toLowerCase(), sortEl.value);
            console.log(`Products loaded from server (${PRODUCTS.length} items).`);
        } catch (error) {
            console.error('API Error (fetchProducts):', error);
            // This error is what you are investigating!
        }
    }
    
    async function syncCartToDatabase() {
        if (!SESSION || !SESSION.id) return; // Only sync if logged in

        try {
            const response = await fetch(`${API_BASE_URL}/users/cart`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: SESSION.id, cart: CART }),
            });

            if (!response.ok) throw new Error('Failed to sync cart');
            console.log('Cart synchronized to database.');

        } catch (error) {
            console.error('API Error (syncCartToDatabase):', error);
        }
    }

    async function placeOrder(orderData) {
        try {
            const response = await fetch(`${API_BASE_URL}/orders`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData),
            });
            if (!response.ok) throw new Error('Order placement failed');
            
            CART = [];
            if(SESSION) { 
                SESSION.cart = []; 
                saveSession(); 
            }
            renderCart();
            alert('Order placed successfully! Thank you for shopping with BrahminBazaar.');
        } catch (error) {
            console.error('API Error (placeOrder):', error);
            alert('Failed to place order. Please try again.');
        }
    }

    // --- CART LOGIC ---
    window.addItemToCart = (productId, variety, basePrice, title) => {
        const existing = CART.find(item => item.id === productId && item.variety === variety);
        const price = parseFloat(basePrice); 
        
        if (existing) {
            existing.qty += 1;
        } else {
            CART.push({
                id: productId, 
                title: title,
                price: price,
                qty: 1,
                variety: variety 
            });
        }

        renderCart();
        saveSession(); 
        alert(`Added ${title} (${variety}) to cart!`);
    };

    window.removeItemFromCart = (productId, variety) => {
        const index = CART.findIndex(item => item.id === productId && item.variety === variety);
        if (index > -1) {
            CART.splice(index, 1);
            renderCart();
            saveSession(); 
        }
    };
    
    // --- AUTHENTICATION & SESSION ---
    // (Existing renderGreeting, logout, authForm listener, and sellerRegForm listener here, using API calls)
    
    function renderGreeting() {
        const user = SESSION;
        if (user) {
            greetingEl.textContent = `Hello, ${user.name}!`;
            authLink.style.display = 'none';
            logoutLink.style.display = 'block';
        } else {
            greetingEl.textContent = `Welcome to BrahminBazaar.`;
            authLink.style.display = 'block';
            logoutLink.style.display = 'none';
        }
    }
    
    window.logout = (e) => {
        e.preventDefault();
        SESSION = null;
        CART = [];
        saveSession(); 
        renderGreeting();
        renderCart();
        alert('You have been logged out.');
    };

    if(authForm) {
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('authEmail').value;
            const pass = document.getElementById('authPass').value;
            const isLogin = !document.getElementById('authName'); 

            let payload = { email, pass };
            let endpoint = 'login';

            if (!isLogin) {
                const name = document.getElementById('authName').value;
                const phone = document.getElementById('authPhone').value;
                const address = document.getElementById('authAddress').value;
                payload = { name, phone, email, address, pass };
                endpoint = 'register';
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/users/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                const result = await response.json();

                if (!response.ok) {
                    return alert(result.message || 'Authentication failed. Please try again.');
                }
                
                if (endpoint === 'register') {
                    alert('Registration successful! You can now log in.');
                    if(typeof toggleAuth === 'function') toggleAuth(true); 
                } else {
                    SESSION = { 
                        id: result.id, 
                        name: result.name, 
                        email: result.email, 
                        phone: result.phone, 
                        address: result.address 
                    };
                    CART = result.cart || []; 
                    
                    saveSession(); 
                    renderGreeting();
                    renderCart();
                    if(typeof toggleAuth === 'function') toggleAuth(false);
                    alert('Logged in successfully.');
                }

            } catch (error) {
                alert('An error occurred during authentication.');
                console.error('Auth Error:', error);
            }
        });
    }

    if(sellerRegForm) {
        sellerRegForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form).entries());
            
            const payload = {
                sellerName: data.seller_name,
                sellerEmail: data.seller_email,
                productName: data.product_name,
                productPrice: parseFloat(data.product_price),
                productDescription: data.product_description
            };

            try {
                const response = await fetch(`${API_BASE_URL}/sellers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) throw new Error('Submission failed');

                form.reset();
                alert('Seller Application submitted successfully! Awaiting admin review.');
            } catch (error) {
                console.error('Seller App Error:', error);
                alert('Failed to submit seller application. Please check server status.');
            }
        });
    }

    // --- CHECKOUT LOGIC ---
    if(checkoutBtnEl) {
        checkoutBtnEl.onclick = () => {
            if (!SESSION) {
                alert('Please log in before proceeding to checkout.');
                if(typeof toggleAuth === 'function') toggleAuth(true); 
                return;
            }
            if (CART.length === 0) return alert('Your cart is empty.');

            const orderItems = CART.map(item => ({
                productId: item.id, 
                title: item.title,
                price: item.price,
                qty: item.qty,
                variety: item.variety
            }));
            
            const total = CART.reduce((acc, item) => acc + (item.price * item.qty), 0);
            
            const orderPayload = {
                userId: SESSION.id,
                userName: SESSION.name,
                userEmail: SESSION.email,
                shippingAddress: SESSION.address,
                items: orderItems,
                totalAmount: total,
                status: 'Pending'
            };

            if (confirm(`Confirm order for ₹${money(total)} to ${SESSION.address}?`)) {
                placeOrder(orderPayload);
            }
        };
    }
    
    // --- INIT & RELOAD ---
    function loadSession() {
        const storedSession = localStorage.getItem('BB_Session');
        if (storedSession) {
            SESSION = JSON.parse(storedSession);
            CART = SESSION.cart || []; 
        }
    }
    
    function init(){
        loadSession(); 
        fetchProducts(); 
        renderGreeting();
        renderCart();
        
        // --- Existing rendering and utility functions (e.g., renderChips, renderList, renderCart) must be placed here ---

        // =========================================================================================
        // NOTE: ADD THE REST OF YOUR CLIENT-SIDE RENDERING FUNCTIONS HERE (renderChips, renderList, etc.)
        // These functions were not part of the API-change script and are needed for the UI to work.
        // =========================================================================================
        
        // --- START OF MISSING RENDERING FUNCTIONS ---
        
        function renderChips(activeCategory) {
            // Find all unique categories from the PRODUCTS array
            const categories = ['All', ...new Set(PRODUCTS.map(p => p.category))];
            chipsEl.innerHTML = categories.map(cat => 
                `<span class="chip ${cat === activeCategory ? 'active' : ''}" onclick="window.filterCategory('${cat}')">${cat}</span>`
            ).join('');
        }

        function renderList(category, search, sort) {
            let filteredProducts = PRODUCTS.filter(p => 
                (category === 'All' || p.category === category) &&
                (p.title.toLowerCase().includes(search) || p.tagline.toLowerCase().includes(search))
            );

            // Sorting logic
            if (sort === 'price_asc') {
                filteredProducts.sort((a, b) => a.basePrice - b.basePrice);
            } else if (sort === 'price_desc') {
                filteredProducts.sort((a, b) => b.basePrice - a.basePrice);
            }

            productsGridEl.innerHTML = filteredProducts.map(product => {
                // Determine the correct unit display
                const unit = product.isLiquid ? 'L' : 'Kg';
                
                // Generate variety options HTML
                const varietyOptions = product.varieties.map(v => 
                    `<option value="${v}">${v}</option>`
                ).join('');

                return `
                    <div class="product-card" data-id="${product.id}">
                        <img src="${product.img}" alt="${product.title}" class="product-img" loading="lazy">
                        <div class="product-info">
                            <h3>${product.title}</h3>
                            <p class="tagline">${product.tagline}</p>
                            
                            <div class="price-section">
                                <span class="price">₹${money(product.basePrice)} / ${unit}</span>
                            </div>

                            <div class="actions">
                                <select class="variety-select" id="variety-${product.id}">
                                    ${varietyOptions}
                                </select>
                                <button onclick="
                                    const select = document.getElementById('variety-${product.id}');
                                    const selectedVariety = select.value;
                                    window.addItemToCart('${product.id}', selectedVariety, ${product.basePrice}, '${product.title.replace(/'/g, "\\'")}')
                                ">Add to Cart</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            productCountTextEl.textContent = `${filteredProducts.length} items found.`;
        }

        window.filterCategory = (category) => {
            chipsEl.querySelectorAll('.chip').forEach(chip => chip.classList.remove('active'));
            chipsEl.querySelector(`.chip:contains(${category})`).classList.add('active');
            renderList(category, (searchEl.value || '').trim().toLowerCase(), sortEl.value);
        };
        
        function renderCart() {
            let subtotal = 0;
            let count = 0;

            const cartHtml = CART.map(item => {
                const itemTotal = item.price * item.qty;
                subtotal += itemTotal;
                count += item.qty;
                
                return `
                    <li class="cart-item" data-id="${item.id}" data-variety="${item.variety}">
                        <div class="cart-details">
                            <span class="cart-title">${item.title} (${item.variety})</span>
                            <span class="cart-price">₹${money(item.price)} x ${item.qty}</span>
                        </div>
                        <button class="remove-btn" onclick="window.removeItemFromCart('${item.id}', '${item.variety}')">X</button>
                    </li>
                `;
            }).join('') || '<li class="empty-cart">Your cart is empty.</li>';

            cartListEl.innerHTML = cartHtml;
            subtotalEl.textContent = `₹${money(subtotal)}`;
            cartCountEl.textContent = CART.length; // Number of unique items
            cartItemsCountEl.textContent = `${count} items`; // Total quantity
        }
        
        // --- END OF MISSING RENDERING FUNCTIONS ---
        
        // Attach listeners after functions are defined
        if(searchEl && sortEl) {
            searchEl.addEventListener('input', () => {
                const active = (chipsEl.querySelector('.chip.active') || {}).textContent || 'All';
                renderList(active, (searchEl.value || '').trim().toLowerCase(), sortEl.value);
            });
            sortEl.addEventListener('change', () => {
                const active = (chipsEl.querySelector('.chip.active') || {}).textContent || 'All';
                renderList(active, (searchEl.value || '').trim().toLowerCase(), sortEl.value);
            });
        }
        
        // Existing WhatsApp/Contact button setup (ensure WHATSAPP_NUMBER is defined)
        const whatsappBtnLarge = document.getElementById('whatsappBtnLarge');
        if (whatsappBtnLarge) {
            const message = encodeURIComponent('Hello, I am interested in BrahminBazaar products. Can you help me with my order?');
            whatsappBtnLarge.href = `https://wa.me/${WHATSAPP_NUMBER}?text=${message}`;
        }
        
        const sellerRegisterBtn = document.getElementById('sellerRegisterBtn');
        if (sellerRegisterBtn) {
            const sellerMessage = encodeURIComponent('Hello, I am interested in registering as a seller on BrahminBazaar. Please provide the next steps.');
            sellerRegisterBtn.href = `https://wa.me/${WHATSAPP_NUMBER}?text=${sellerMessage}`;
        }
        
        if(headerContactBtn) {
            headerContactBtn.addEventListener('click', () => {
                if (contactSection) {
                    contactSection.scrollIntoView({behavior: 'smooth'});
                }
            });
        }
        
        searchEl.addEventListener('keydown', (e)=> { if(e.key === 'Enter') {
            const active = (chipsEl.querySelector('.chip.active') || {}).textContent || 'All';
            renderList(active, (searchEl.value || '').trim().toLowerCase(), sortEl.value);
        }});
        
    }

    // Call init to start the application
    init();

    // Since we are using API calls and syncCartToDatabase, we no longer need the 'beforeunload' listener for local storage.

  </script>
<!-- === /DB WIRE (BUYER) === -->
</body>
</html>