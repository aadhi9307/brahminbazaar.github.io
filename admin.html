<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>BrahminBazaar Admin Panel</title>
  <style>
    :root{
       /* --- THEME: Light Yellow / Gold --- */
       --primary-dark: #B7950B;
       --primary: #F1C40F;
       --primary-light: #FFF9C4;
       
       --text-dark: #333333;
       --muted: #777777;
       
       --card: #FFFFFF;
       --bg: #FFFEFA;
       
       --radius: 12px;
       --shadow: 0 8px 15px rgba(241, 196, 15, 0.15);
       --max-width: 1400px;
    } 
    
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:var(--bg);color:var(--text-dark); padding-bottom: 40px; -webkit-tap-highlight-color: transparent;}
    
    /* Header */
    header{background:var(--primary); color:#FFF; padding:16px 20px; box-shadow:0 4px 10px rgba(0,0,0,0.1); position: sticky; top:0; z-index: 50;}
    .wrap{max-width:var(--max-width);margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:18px;}
    .brand{display:flex;align-items:center;gap:12px}
    .brand .logo-icon{height:36px;width:auto;display:block; background:#fff; border-radius:4px; padding:2px;}
    h1{font-size:1.3rem;margin:0; font-weight:800; color:#FFF; text-shadow: 0 1px 2px rgba(0,0,0,0.1);}
    
    .back-link{color:var(--primary-dark); background:#fff; padding: 6px 12px; border-radius: 6px; font-size:0.85rem; text-decoration:none; font-weight:700; transition: all .2s}
    .back-link:hover{box-shadow: 0 4px 10px rgba(0,0,0,0.2);}

    /* Login Screen */
    #login-screen{position:fixed;inset:0;background:rgba(255, 254, 250, 0.98); display:flex;align-items:center;justify-content:center;z-index:1000;}
    .login-box{background:var(--card);padding:40px;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.1);max-width:360px;width:92%;text-align:center; border:1px solid var(--primary-light);}
    .login-box h2{color:var(--primary-dark);margin-bottom:20px}
    .login-box input{width:100%;padding:14px;margin-bottom:15px;border:1px solid #ddd;border-radius:8px; outline:none; font-size: 1rem;}
    .login-box input:focus{border-color:var(--primary); box-shadow: 0 0 0 3px rgba(241,196,15,0.2);}
    .login-box button{width:100%;padding:14px;background:var(--primary);color:#000;border:none;border-radius:8px;font-weight:700;cursor:pointer;}
    .login-error { color: red; margin-bottom: 15px; font-size: 0.9rem; display: none; }

    /* Main */
    main{max-width:var(--max-width);margin:22px auto;padding:0 20px;}
    
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:var(--card);padding:20px;border-radius:var(--radius);box-shadow:var(--shadow);border-left:5px solid var(--primary)}
    .stat-card h3{font-size:0.8rem;color:var(--muted);margin-bottom:5px; text-transform: uppercase; letter-spacing: 0.5px;}
    .stat-card .value{font-size:1.8rem;font-weight:800;color:var(--text-dark)}

    /* Tabs */
    .tabs{display:flex;border-bottom:2px solid #EEE;margin-bottom:20px;overflow-x:auto; gap: 20px; padding-bottom: 5px; -webkit-overflow-scrolling: touch;}
    .tab-btn{padding:10px 5px;cursor:pointer;font-weight:600;border:none;background:transparent;border-bottom:3px solid transparent;margin-bottom:-5px;transition:all .2s;white-space:nowrap; color:var(--muted); font-size: 1rem;}
    .tab-btn.active{color:var(--primary-dark);border-bottom:3px solid var(--primary)}
    .tab-content{display:none; animation: fadeIn 0.3s ease;}
    .tab-content.active{display:block}

    /* Tables */
    .table-container{background:var(--card);border-radius:var(--radius);padding:0;box-shadow:var(--shadow);overflow-x:auto; border:1px solid #F0F0F0; -webkit-overflow-scrolling: touch;}
    table{width:100%;border-collapse:collapse;min-width:800px}
    th,td{padding:14px 20px;text-align:left;border-bottom:1px solid #f9f9f9;font-size:0.95rem; vertical-align: middle;}
    th{background:var(--primary-light);color:var(--primary-dark);font-weight:700; font-size: 0.85rem; text-transform: uppercase;}
    .current-price{font-weight:700;color:var(--text-dark)}
    
    .thumb-img { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; border: 1px solid #eee; margin-right: 10px; vertical-align: middle; }

    /* Badges */
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; white-space: nowrap; }
    .badge-in { background-color: #E8F5E9; color: #2E7D32; }
    .badge-out { background-color: #FFEBEE; color: #C62828; }
    .badge-low { background-color: #FFF8E1; color: #F57F17; }
    .badge-pending { background-color: #FFF3E0; color: #E65100; }
    
    /* Buttons */
    .btn-edit,.btn-save{background:var(--primary);color:#000;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-size:0.85rem;font-weight:600; min-width: 60px;}
    .btn-delete{background:#FFEBEE;color:#D32F2F;border:1px solid #FFCDD2;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:0.85rem;font-weight:600;margin-left:5px}
    .btn-detail{background:var(--primary-light);color:var(--primary-dark);border:1px solid var(--primary);padding:8px 14px;border-radius:6px;cursor:pointer;font-size:0.85rem;font-weight:600; text-decoration: none;}
    .btn-approve{background:#2E7D32; color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; font-size:0.85rem; font-weight:600; min-width:80px;}
    
    .add-product-btn{background:#000;color:#FFF;padding:12px 20px;border:none;border-radius:8px;font-weight:700;cursor:pointer;transition:background .2s;}
    .add-product-btn:hover{background:var(--primary); color: #000;}
    .add-product-btn:disabled { background: #999; cursor: not-allowed; }

    /* Top controls */
    .top-controls{display:flex;gap:10px;margin-bottom:15px;align-items:center;flex-wrap:wrap}
    .top-controls input,.top-controls select{padding:12px;border:1px solid #ddd;border-radius:8px;min-width:240px; outline:none; background: #fff; flex: 1;}
    .top-controls input:focus, .top-controls select:focus{border-color:var(--primary);}
    @media(max-width: 600px) {
        .add-product-btn { width: 100%; margin-top: 10px; }
        .top-controls input, .top-controls select { min-width: 100%; }
    }

    /* Modal */
    #modalBack{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(2px);z-index:100;display:none;align-items:center;justify-content:center}
    #modalContent{background:var(--card);padding:0;border-radius:var(--radius);box-shadow:0 10px 40px rgba(0,0,0,0.2);max-width:700px;width:94%; max-height: 90vh; display: flex; flex-direction: column;}
    
    .modal-header { padding: 20px; border-bottom: 1px solid #EEE; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { margin: 0; }
    .modal-body { padding: 20px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
    .modal-footer { padding: 20px; border-top: 1px solid #EEE; display: flex; justify-content: flex-end; gap: 10px; background: #FAFAFA; border-radius: 0 0 var(--radius) var(--radius); }

    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-size: 0.85rem; font-weight: 700; color: var(--muted); margin-bottom: 6px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; outline: none; -webkit-appearance: none;}
    .form-group input:focus { border-color: var(--primary); }

    /* Updated Variety & Size Styles */
    .variety-group { border: 1px solid #EEE; border-radius: 8px; padding: 15px; background: #FAFAFA; margin-bottom: 15px; }
    .variety-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .variety-header input { width: auto; flex: 1; margin-right: 10px; font-weight: 700; border: 1px solid #DDD; }
    
    .sizes-container { padding-left: 0; }
    .size-row { display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 8px; margin-bottom: 8px; align-items: center; }
    .size-row input { padding: 8px; border: 1px solid #DDD; border-radius: 6px; font-size: 0.9rem; }
    .btn-remove-row { color: red; background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 0 8px; }
    .btn-small-add { background: #fff; border: 1px dashed #999; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; margin-top: 5px; width: 100%; }
    .btn-small-add:hover { border-color: var(--primary); color: #000; }

    @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

    /* Settings Page */
    .settings-panel { max-width: 600px; background: #fff; padding: 30px; border-radius: 12px; box-shadow: var(--shadow); width: 100%; }
    
    /* Order Detail Styles */
    .order-detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .detail-box { background: #FAFAFA; padding: 15px; border-radius: 8px; border: 1px solid #EEE; }
    .detail-label { font-size: 0.8rem; color: #777; font-weight: 700; text-transform: uppercase; margin-bottom: 5px; }
    .detail-value { font-size: 1rem; font-weight: 600; color: #333; }
    .bill-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #EEE; font-size: 0.9rem; }
    .bill-row.total { border-top: 2px solid #EEE; border-bottom: none; font-weight: 800; font-size: 1.1rem; margin-top: 10px; padding-top: 15px; }

    /* Loader */
    .loader { display: none; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="modalBack" role="dialog" aria-modal="true">
    <div id="modalContent"></div>
  </div>

  <div id="login-screen">
    <div class="login-box">
      <img src="logo.png" alt="BrahminBazaar Admin" style="height:60px; margin-bottom:20px; display:block; margin-left:auto; margin-right:auto;">
      <h2>Admin Access</h2>
      <div id="loginError" class="login-error">Invalid Credentials</div>
      <form id="loginForm">
        <input type="password" id="adminPassword" placeholder="Enter Password" required autocomplete="current-password">
        <button type="submit" id="btnLogin">
            <span class="btn-text">Unlock Panel</span>
            <div class="loader"></div>
        </button>
      </form>
      <p style="margin-top:20px; font-size:0.9rem"><a href="index.html" style="color:var(--muted); text-decoration:none">‚Üê Return to Shop</a></p>
    </div>
  </div>

  <header id="adminHeader" style="display:none;">
    <div class="wrap">
      <div class="brand">
        <img src="logo.png" alt="Logo" class="logo-icon">
        <h1>BrahminBazaar <span style="font-weight:400; opacity:0.8; font-size:0.9em">| Admin</span></h1>
      </div>
      <a class="back-link" href="index.html">Open Shop View</a>
    </div>
  </header>

  <main id="adminMain" style="display:none;">
    <div class="stats-grid">
      <div class="stat-card"><h3>Orders to Process</h3><div class="value" id="pendingOrders">...</div></div>
      <div class="stat-card"><h3>Product Requests</h3><div class="value" id="pendingRequests">...</div></div>
      <div class="stat-card"><h3>Registered Sellers</h3><div class="value" id="totalSellers">...</div></div>
      <div class="stat-card"><h3>Total Products</h3><div class="value" id="totalProducts">...</div></div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="products">Inventory</button>
      <button class="tab-btn" data-tab="requests">Product Requests</button>
      <button class="tab-btn" data-tab="orders">Orders</button>
      <button class="tab-btn" data-tab="users">Customers</button>
      <button class="tab-btn" data-tab="sellers">Sellers</button>
      <button class="tab-btn" data-tab="settings">Site Settings</button>
    </div>

    <div id="products" class="tab-content active">
      <div class="top-controls">
        <input type="text" id="productSearch" placeholder="Search by Name, ID, Category...">
        <select id="deptFilter" style="max-width:180px">
          <option value="All">All Departments</option>
        </select>
        <div style="flex:1"></div>
        <button class="add-product-btn" onclick="openProductModal()">+ Add New Product</button>
      </div>
      
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th style="width:60px">Img</th>
              <th>Product Details</th>
              <th>Category</th>
              <th>Varieties / Pricing</th>
              <th>Stock Status</th>
              <th style="text-align:right">Actions</th>
            </tr>
          </thead>
          <tbody id="productTableBody"></tbody>
        </table>
        <div id="productLoader" style="padding:20px; text-align:center; display:none">Loading inventory...</div>
      </div>
    </div>

    <div id="requests" class="tab-content">
      <div class="top-controls">
        <input type="text" id="reqSearch" placeholder="Search by Seller, Phone, Email, Product...">
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Seller</th>
              <th>Product Proposed</th>
              <th>Category</th>
              <th>Proposed Price</th>
              <th>Status</th>
              <th style="text-align:right">Actions</th>
            </tr>
          </thead>
          <tbody id="reqTableBody"></tbody>
        </table>
        <div id="reqLoader" style="padding:20px; text-align:center; display:none">Loading requests...</div>
      </div>
    </div>

    <div id="orders" class="tab-content">
      <div class="top-controls">
        <input type="text" id="orderSearch" placeholder="Search by Order ID, Phone, Email, Item...">
        <select id="orderStatusFilter">
            <option value="All">All Status</option>
            <option value="Processing">Processing</option>
            <option value="Completed">Completed</option>
        </select>
      </div>
      <div class="table-container">
        <table>
          <thead><tr><th>ID</th><th>Customer</th><th>Items</th><th>Total</th><th>Status</th><th>Action</th></tr></thead>
          <tbody id="orderTableBody"></tbody>
        </table>
        <div id="ordersLoader" style="padding:20px; text-align:center; display:none">Loading orders...</div>
      </div>
    </div>

    <div id="users" class="tab-content">
      <div class="top-controls">
        <input type="text" id="userSearch" placeholder="Search by Name, Phone, Email, Address...">
      </div>
      <div class="table-container">
        <table>
          <thead><tr><th>Name</th><th>Phone</th><th>Email</th><th>Saved Address</th></tr></thead>
          <tbody id="userTableBody"></tbody>
        </table>
        <div id="usersLoader" style="padding:20px; text-align:center; display:none">Loading users...</div>
      </div>
    </div>

    <div id="sellers" class="tab-content">
      <div class="top-controls">
        <input type="text" id="sellerSearch" placeholder="Search by Name, Shop, Phone, Email, Place...">
      </div>
      <div class="table-container">
        <table>
          <thead><tr><th>Seller Name</th><th>Shop / Business</th><th>Contact</th><th>Location</th><th>Experience</th></tr></thead>
          <tbody id="sellerTableBody"></tbody>
        </table>
        <div id="sellersLoader" style="padding:20px; text-align:center; display:none">Loading sellers...</div>
      </div>
    </div>

    <div id="settings" class="tab-content">
      <div class="settings-panel">
          <h2 style="margin-bottom:20px; border-bottom:1px solid #EEE; padding-bottom:10px">Checkout Configuration</h2>
          <div style="display:flex; gap:20px; flex-wrap:wrap">
              <div class="form-group" style="flex:1; min-width:200px">
                  <label>CGST (%)</label>
                  <input type="number" id="setCGST" step="0.1" placeholder="e.g. 2.5">
              </div>
              <div class="form-group" style="flex:1; min-width:200px">
                  <label>SGST (%)</label>
                  <input type="number" id="setSGST" step="0.1" placeholder="e.g. 2.5">
              </div>
          </div>
          <div style="display:flex; gap:20px; flex-wrap:wrap">
              <div class="form-group" style="flex:1; min-width:200px">
                  <label>Delivery Fee (‚Çπ)</label>
                  <input type="number" id="setDelivery" placeholder="e.g. 50">
              </div>
              <div class="form-group" style="flex:1; min-width:200px">
                  <label>Processing Fee (‚Çπ)</label>
                  <input type="number" id="setFee" placeholder="e.g. 50">
              </div>
          </div>
          <button class="add-product-btn" id="btnSaveSettings" onclick="saveSettings()">Save Configuration</button>
      </div>
    </div>

  </main>

  <script>
    /*******************************************************
     * BACKEND API LAYER (Unified & Robust)
     *******************************************************/
    const USE_MOCK_BACKEND = true; 
    const API_BASE_URL = 'http://localhost:3000/api'; 

    class ApiService {
        constructor() {
            this.token = sessionStorage.getItem('bb_admin_token') || null;
        }

        async request(endpoint, method = 'GET', body = null) {
            if (USE_MOCK_BACKEND) return this.mockRequest(endpoint, method, body);
            // Real fetch implementation removed for brevity in this refactor, assumes mock mode
        }

        async mockRequest(endpoint, method, body) {
            await new Promise(r => setTimeout(r, 300)); // Simulate lighter network delay

            const KEYS = {
                PROD: 'brahminbazaar_admin_products',
                ORD: 'brahminbazaar_orders',
                ACC: 'bb_accounts_v1',
                REQ: 'bb_seller_requests',
                TAX_C: 'site_cgst', TAX_S: 'site_sgst',
                DEL: 'site_delivery_fee', FEE: 'site_processing_fee'
            };

            const read = (k) => JSON.parse(localStorage.getItem(k) || (k === KEYS.ACC ? '{}' : '[]'));
            const write = (k, v) => localStorage.setItem(k, JSON.stringify(v));

            if (endpoint === '/login' && method === 'POST') {
                if (body.password === 'admin123') return { success: true, token: 'mock_' + Date.now() };
                throw new Error('Invalid Password');
            }

            // Products
            if (endpoint === '/products') {
                if (method === 'GET') return read(KEYS.PROD);
                if (method === 'POST') {
                    let list = read(KEYS.PROD);
                    const idx = list.findIndex(p => p.id === body.id);
                    if (idx > -1) list[idx] = body; else list.push(body);
                    write(KEYS.PROD, list);
                    return { success: true };
                }
            }
            if (method === 'DELETE' && endpoint.startsWith('/products/')) {
                const id = endpoint.split('/')[2];
                write(KEYS.PROD, read(KEYS.PROD).filter(p => p.id !== id));
                return { success: true };
            }

            // Requests
            if (endpoint === '/requests') return read(KEYS.REQ);
            if (method === 'PATCH' && endpoint.includes('/requests/')) {
                const id = endpoint.split('/')[2];
                let list = read(KEYS.REQ);
                let r = list.find(x => x.id === id);
                if(r) r.status = body.status;
                write(KEYS.REQ, list);
                return { success: true };
            }

            // Orders
            if (endpoint === '/orders') return read(KEYS.ORD);
            if (method === 'PATCH' && endpoint.includes('/orders/')) {
                const id = endpoint.split('/')[2];
                let list = read(KEYS.ORD);
                let o = list.find(x => x.id === id);
                if(o) o.status = body.status;
                write(KEYS.ORD, list);
                return { success: true };
            }

            // Users
            if (endpoint === '/users') return read(KEYS.ACC);

            // Settings
            if (endpoint === '/settings') {
                if (method === 'GET') return {
                    cgst: localStorage.getItem(KEYS.TAX_C) || 2.5,
                    sgst: localStorage.getItem(KEYS.TAX_S) || 2.5,
                    delivery: localStorage.getItem(KEYS.DEL) || 50,
                    fee: localStorage.getItem(KEYS.FEE) || 50
                };
                if (method === 'POST') {
                    localStorage.setItem(KEYS.TAX_C, body.cgst);
                    localStorage.setItem(KEYS.TAX_S, body.sgst);
                    localStorage.setItem(KEYS.DEL, body.delivery);
                    localStorage.setItem(KEYS.FEE, body.fee);
                    return { success: true };
                }
            }
        }
        
        async login(password) { return this.request('/login', 'POST', { password }); }
        async getProducts() { return this.request('/products'); }
        async saveProduct(product) { return this.request('/products', 'POST', product); }
        async deleteProduct(id) { return this.request(`/products/${id}`, 'DELETE'); }
        async getRequests() { return this.request('/requests'); }
        async updateRequestStatus(id, status) { return this.request(`/requests/${id}/status`, 'PATCH', { status }); }
        async getOrders() { return this.request('/orders'); }
        async updateOrderStatus(id, status) { return this.request(`/orders/${id}/status`, 'PATCH', { status }); }
        async getUsers() { return this.request('/users'); }
        async getSettings() { return this.request('/settings'); }
        async saveSettings(settings) { return this.request('/settings', 'POST', settings); }
    }

    /*************** STATE & INIT ***************/
    const API = new ApiService();
    let PRODUCTS = [], ORDERS = [], REQUESTS = [], USER_LIST = [], SELLERS_LIST = [];

    async function init() {
        try {
            await Promise.all([loadProducts(), loadRequests(), loadOrders(), loadUsers(), loadSettings()]);
            // Extract Sellers from requests for the "Sellers" tab
            processSellersFromRequests();
            updateStats();
            populateDeptFilter();
        } catch (e) {
            console.error(e);
            alert("Failed to load data.");
        }
    }

    // --- Data Loading with Migration Safety ---
    async function loadProducts() { 
        document.getElementById('productLoader').style.display = 'block';
        try {
            PRODUCTS = await API.getProducts();
            // MIGRATION: Ensure all products have valid options and fields
            PRODUCTS = PRODUCTS.map(p => {
                if (!p.options || p.options.length === 0) {
                    // Backward compatibility for old "basePrice" products
                    const price = p.basePrice || 0;
                    p.options = [{ label: 'Standard', price: price, stock: p.inStock ? 50 : 0, size: 'Standard' }];
                }
                // Ensure Dept
                if (!p.dept) p.dept = p.mainCategory || 'Groceries';
                return p;
            });
            renderProducts();
        } finally {
            document.getElementById('productLoader').style.display = 'none';
        }
    }

    async function loadRequests() { 
        document.getElementById('reqLoader').style.display = 'block';
        try { REQUESTS = await API.getRequests(); renderRequests(); }
        finally { document.getElementById('reqLoader').style.display = 'none'; }
    }

    async function loadOrders() { 
        document.getElementById('ordersLoader').style.display = 'block';
        try { ORDERS = await API.getOrders(); renderOrders(); }
        finally { document.getElementById('ordersLoader').style.display = 'none'; }
    }

    async function loadUsers() {
        document.getElementById('usersLoader').style.display = 'block';
        try {
            const uObj = await API.getUsers();
            USER_LIST = [];
            const seen = new Set();
            if (uObj) Object.values(uObj).forEach(u => {
                if(u.email && !seen.has(u.email)) { USER_LIST.push(u); seen.add(u.email); }
            });
            renderUsers();
        } finally { document.getElementById('usersLoader').style.display = 'none'; }
    }

    async function loadSettings() {
        const s = await API.getSettings();
        document.getElementById('setCGST').value = s.cgst;
        document.getElementById('setSGST').value = s.sgst;
        document.getElementById('setDelivery').value = s.delivery;
        document.getElementById('setFee').value = s.fee;
    }

    function processSellersFromRequests() {
        const map = new Map();
        REQUESTS.forEach(r => {
            if(!map.has(r.sellerPhone)) {
                map.set(r.sellerPhone, {
                    name: r.sellerName,
                    phone: r.sellerPhone,
                    email: r.sellerEmail || 'N/A',
                    shop: r.sellerShop || 'N/A', 
                    place: r.sellerPlace || 'N/A',
                    exp: r.sellerExp || 'Active Partner' // Fallback
                });
            }
        });
        SELLERS_LIST = Array.from(map.values());
        renderSellers();
    }

    function updateStats() {
        document.getElementById('pendingOrders').textContent = ORDERS.filter(o => o.status === 'Processing').length;
        document.getElementById('pendingRequests').textContent = REQUESTS.filter(r => r.status === 'Pending Approval').length;
        document.getElementById('totalSellers').textContent = SELLERS_LIST.length;
        document.getElementById('totalProducts').textContent = PRODUCTS.length;
    }

    function populateDeptFilter() {
        const depts = new Set(PRODUCTS.map(p => p.dept));
        const sel = document.getElementById('deptFilter');
        sel.innerHTML = '<option value="All">All Departments</option>';
        depts.forEach(d => {
            if(!d) return;
            const opt = document.createElement('option');
            opt.value = d; opt.textContent = d;
            sel.appendChild(opt);
        });
    }

    /*************** RENDERERS ***************/
    
    // Helper to search across all fields of an object
    const matchAll = (obj, term) => {
        if(!term) return true;
        const searchStr = Object.values(obj).filter(v=>v && typeof v !== 'object').join(' ').toLowerCase();
        // Also check complex nested fields if specific logic requires, but flat join usually works for simple searching
        return searchStr.includes(term);
    };

    function renderProducts() {
        const q = document.getElementById('productSearch').value.toLowerCase();
        const dept = document.getElementById('deptFilter').value;
        const tbody = document.getElementById('productTableBody');
        tbody.innerHTML = '';
        
        const filtered = PRODUCTS.filter(p => {
            if(dept !== 'All' && p.dept !== dept) return false;
            // Enhanced: Search title, ID, subcat
            return (p.title + p.id + p.subCategory).toLowerCase().includes(q);
        });

        filtered.forEach(p => {
             // Logic: Calculate total stock & price range
             const totalStock = p.options.reduce((sum, o) => sum + (Number(o.stock)||0), 0);
             const prices = p.options.map(o => Number(o.price));
             const priceDisplay = prices.length > 1 
                ? `‚Çπ${Math.min(...prices)} - ‚Çπ${Math.max(...prices)}` 
                : (prices[0] ? `‚Çπ${prices[0]}` : '-');

             let badgeClass = 'badge-in', badgeText = 'In Stock';
             if(totalStock === 0) { badgeClass = 'badge-out'; badgeText = 'Out of Stock'; }
             else if(totalStock < 10) { badgeClass = 'badge-low'; badgeText = 'Low: ' + totalStock; }
             else { badgeText = 'In: ' + totalStock; }

             const img = (p.images && p.images[0]) ? p.images[0] : (p.img || 'https://via.placeholder.com/40');

             const tr = document.createElement('tr');
             tr.innerHTML = `
                <td><img src="${img}" class="thumb-img"></td>
                <td><div style="font-weight:700">${p.title}</div><div style="font-size:0.8rem; color:#888">${p.id}</div></td>
                <td>${p.dept} <span style="color:#ccc">/</span> ${p.subCategory}</td>
                <td>${p.options.length} Variants<br><b>${priceDisplay}</b></td>
                <td><span class="badge ${badgeClass}">${badgeText}</span></td>
                <td style="text-align:right">
                    <button class="btn-edit" onclick="openProductModal('${p.id}')">Edit</button>
                    <button class="btn-delete" onclick="deleteProduct('${p.id}')">üóë</button>
                </td>
             `;
             tbody.appendChild(tr);
        });
    }

    function renderRequests() {
        const q = document.getElementById('reqSearch').value.toLowerCase();
        const tbody = document.getElementById('reqTableBody');
        tbody.innerHTML = '';

        REQUESTS.filter(r => {
            // Comprehensive Search
            const str = (r.sellerName + r.sellerPhone + (r.sellerEmail||'') + r.productData.title + r.productData.subCategory).toLowerCase();
            return str.includes(q);
        }).reverse().forEach(r => {
             const p = r.productData;
             const price = p.options && p.options[0] ? p.options[0].price : 0;
             const isPending = r.status === 'Pending Approval';
             
             const tr = document.createElement('tr');
             tr.innerHTML = `
                <td><b>${r.sellerName}</b><br><small>${r.sellerPhone}</small></td>
                <td>${p.title}</td>
                <td>${p.subCategory}</td>
                <td>‚Çπ${price}</td>
                <td><span class="badge ${isPending?'badge-pending':'badge-in'}">${r.status}</span></td>
                <td style="text-align:right">
                   ${isPending ? `<button class="btn-detail" onclick="viewRequest('${r.id}')">View Details</button>` : ''} 
                   ${isPending ? `<button class="btn-approve" onclick="approveRequest('${r.id}')">Approve</button>` : '<small>Closed</small>'}
                </td>
             `;
             tbody.appendChild(tr);
        });
    }

    function renderSellers() {
        const q = document.getElementById('sellerSearch').value.toLowerCase();
        const tbody = document.getElementById('sellerTableBody');
        tbody.innerHTML = '';
        
        SELLERS_LIST.filter(s => matchAll(s, q)).forEach(s => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
               <td><b>${s.name}</b></td>
               <td>${s.shop}</td>
               <td>${s.phone}<br><small>${s.email}</small></td>
               <td>${s.place}</td>
               <td>${s.exp}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderOrders() {
        const filter = document.getElementById('orderStatusFilter').value;
        const q = document.getElementById('orderSearch').value.toLowerCase();
        const tbody = document.getElementById('orderTableBody');
        
        tbody.innerHTML = ORDERS.filter(o => {
            if(filter !== 'All' && o.status !== filter) return false;
            // Comprehensive Search
            const itemsStr = o.items.map(i => i.title).join(' ');
            const str = (o.id + o.userPhone + (o.userEmail||'') + itemsStr).toLowerCase();
            return str.includes(q);
        }).reverse().map(o => `
            <tr>
                <td><b>${o.id}</b></td>
                <td>${o.userPhone}<br><small>${o.userEmail}</small></td>
                <td><small>${o.items.length} Items</small></td>
                <td>‚Çπ${o.total.toFixed(2)}</td>
                <td><span class="badge ${o.status==='Completed'?'badge-in':'badge-pending'}">${o.status}</span></td>
                <td>
                   <button class="btn-detail" onclick="viewOrder('${o.id}')">View</button>
                   ${o.status!=='Completed' ? `<button class="btn-save" onclick="markComplete('${o.id}')">‚úì</button>` : ''}
                </td>
            </tr>
        `).join('');
    }

    function renderUsers() {
        const q = document.getElementById('userSearch').value.toLowerCase();
        document.getElementById('userTableBody').innerHTML = USER_LIST.filter(u => matchAll(u, q)).map(u => `
            <tr><td>${u.name}</td><td>${u.phone}</td><td>${u.email}</td><td><small>${u.address}</small></td></tr>
        `).join('');
    }

    /*************** ACTIONS & MODALS ***************/
    
    // -- View Request Details --
    window.viewRequest = (rid) => {
        const req = REQUESTS.find(r => r.id === rid);
        if(!req) return;
        const p = req.productData;
        
        const html = `
            <div class="modal-header"><h3>Product Request</h3><button onclick="closeModal()">√ó</button></div>
            <div class="modal-body">
                <div class="detail-box" style="margin-bottom:15px">
                    <div class="detail-label">Seller</div>
                    <div>${req.sellerName} (${req.sellerPhone})</div>
                    <div>${req.sellerEmail}</div>
                </div>
                <div style="display:flex; gap:15px">
                   <img src="${p.img}" style="width:100px; height:100px; object-fit:cover; border-radius:8px">
                   <div>
                       <h4>${p.title}</h4>
                       <div>${p.dept} > ${p.subCategory}</div>
                       <p style="margin-top:5px; color:#555; font-size:0.9rem">${p.description}</p>
                   </div>
                </div>
                <table style="width:100%; margin-top:15px; background:#f9f9f9">
                    <thead><tr><th>Variety</th><th>Size</th><th>Price</th><th>Stock</th></tr></thead>
                    <tbody>
                        ${p.options.map(o => `<tr><td>${o.variety}</td><td>${o.size}</td><td>‚Çπ${o.price}</td><td>${o.stock}</td></tr>`).join('')}
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button class="btn-approve" onclick="approveRequest('${rid}')" style="width:100%">Approve & Add to Inventory</button>
            </div>
        `;
        document.getElementById('modalContent').innerHTML = html;
        document.getElementById('modalBack').style.display = 'flex';
    };

    // -- Approve Request (Defensive) --
    window.approveRequest = async (rid) => {
        if(!confirm("Approve this product? It will appear in the main shop immediately.")) return;
        
        const req = REQUESTS.find(r => r.id === rid);
        if(!req) return alert("Request not found.");

        // Check duplicate
        if(PRODUCTS.some(p => p.id === req.productData.id)) {
            if(!confirm("A product with this ID already exists. Overwrite?")) return;
        }
        
        // Sanitize & Add
        const newProduct = { 
            ...req.productData, 
            id: req.productData.id || ('prod-' + Date.now()),
            inStock: true // Ensure visible
        };
        
        await API.saveProduct(newProduct);
        await API.updateRequestStatus(rid, 'Approved');
        
        closeModal();
        await init(); // Refresh everything
        alert("Product Approved & Added!");
    };

    // -- Product Modal (Clean logic from admin.html) --
    window.openProductModal = (id = null) => {
        const isEdit = !!id;
        let p = isEdit ? PRODUCTS.find(x => x.id === id) : { title:'', dept:'Groceries', subCategory:'', img:'', options: [] };
        
        // Prepare Dept Datalist for UI
        const depts = new Set(PRODUCTS.map(prod => prod.dept).filter(Boolean));
        if(!depts.has('Groceries')) depts.add('Groceries');
        const deptOptionsHTML = Array.from(depts).map(d => `<option value="${d}">`).join('');

        const modal = document.getElementById('modalContent');
        modal.innerHTML = `
            <div class="modal-header"><h3>${isEdit ? 'Edit' : 'Add'} Product</h3><button onclick="closeModal()">√ó</button></div>
            <div class="modal-body">
                <div class="form-group"><label>Title</label><input id="inpTitle" value="${p.title}" placeholder="e.g. Basmati Rice"></div>
                <div class="form-group"><label>Dept</label><input id="inpDept" list="deptList" value="${p.dept}" placeholder="Select or type..."><datalist id="deptList">${deptOptionsHTML}</datalist></div>
                <div class="form-group"><label>Sub-Category</label><input id="inpCat" value="${p.subCategory}"></div>
                <div class="form-group"><label>Image URL</label><input id="inpImg" value="${p.images?p.images[0]:(p.img||'')}" placeholder="http://..."></div>
                <div id="varietiesWrapper"></div>
                <button onclick="addVarietyBlock()" class="btn-small-add" style="margin-top:10px">+ Add Variety Group</button>
            </div>
            <div class="modal-footer"><button class="btn-save" id="btnSaveProd" onclick="saveProduct('${p.id||''}')">Save Product</button></div>
        `;
        
        // Group varieties for display (Clean grouping)
        const grouped = {};
        if(p.options && p.options.length) {
            p.options.forEach(o => {
                const v = o.variety || 'Standard';
                if(!grouped[v]) grouped[v] = [];
                grouped[v].push(o);
            });
        } else { grouped['Standard'] = []; }

        const wrapper = document.getElementById('varietiesWrapper');
        Object.keys(grouped).forEach(vName => {
            const div = addVarietyBlock(vName);
            const container = div.querySelector('.sizes-container');
            grouped[vName].forEach(o => addSizeRow(container, o.size, o.price, o.stock));
            if(!grouped[vName].length) addSizeRow(container); // Empty row if new group
        });

        document.getElementById('modalBack').style.display = 'flex';
    };
    
    window.addVarietyBlock = (name = '') => {
        const d = document.createElement('div'); d.className='variety-group';
        d.innerHTML=`<div class="variety-header"><input class="inp-variety-name" placeholder="Variety Name (e.g. Standard)" value="${name}"><button class="btn-remove-row" onclick="this.closest('.variety-group').remove()">√ó</button></div><div class="sizes-container"></div><button class="btn-small-add" onclick="addSizeRow(this.previousElementSibling)">+ Size</button>`;
        document.getElementById('varietiesWrapper').appendChild(d);
        return d;
    };
    window.addSizeRow = (c,s='',p='',st='') => {
        c.innerHTML += `<div class="size-row"><input class="inp-size" value="${s}" placeholder="Size"><input class="inp-price" value="${p}" placeholder="‚Çπ"><input class="inp-stock" value="${st}" placeholder="Qty"><button class="btn-remove-row" onclick="this.parentElement.remove()">√ó</button></div>`;
    };

    window.saveProduct = async (eid) => {
        const title = document.getElementById('inpTitle').value;
        if(!title) return alert("Title is required");

        const options = [];
        document.querySelectorAll('.variety-group').forEach(grp => {
             const v = grp.querySelector('.inp-variety-name').value || 'Standard';
             grp.querySelectorAll('.size-row').forEach(r => {
                 const size = r.querySelector('.inp-size').value;
                 const price = r.querySelector('.inp-price').value;
                 if(size && price) {
                     options.push({
                         variety: v, size: size, label: size, // Keep label for backward compat
                         price: Number(price), stock: Number(r.querySelector('.inp-stock').value)
                     });
                 }
             });
        });

        if(!options.length) return alert("Add at least one size/price.");

        const prod = {
            id: eid || title.toLowerCase().replace(/[^a-z0-9]/g,'-') + '-' + Math.floor(Math.random()*1000),
            title, dept: document.getElementById('inpDept').value,
            subCategory: document.getElementById('inpCat').value,
            img: document.getElementById('inpImg').value,
            images: [document.getElementById('inpImg').value],
            options, inStock: true
        };
        
        await API.saveProduct(prod);
        closeModal();
        init(); // Refresh inventory stats
    };

    window.deleteProduct = async (id) => { if(confirm("Delete?")) { await API.deleteProduct(id); init(); } };
    window.markComplete = async (id) => { await API.updateOrderStatus(id, 'Completed'); init(); };
    window.viewOrder = (id) => { alert("Full Order Details functionality would be here. (ID: "+id+")"); };
    
    function closeModal() { document.getElementById('modalBack').style.display = 'none'; }
    window.saveSettings = async () => {
        await API.saveSettings({
            cgst: document.getElementById('setCGST').value,
            sgst: document.getElementById('setSGST').value,
            delivery: document.getElementById('setDelivery').value,
            fee: document.getElementById('setFee').value
        });
        alert("Settings Saved");
    };

    // Tabs
    document.querySelectorAll('.tab-btn').forEach(b => b.onclick = () => {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        b.classList.add('active');
        document.getElementById(b.dataset.tab).classList.add('active');
    });

    // Login
    document.getElementById('loginForm').onsubmit = async (e) => {
        e.preventDefault();
        try {
            await API.login(document.getElementById('adminPassword').value);
            document.getElementById('login-screen').style.display='none';
            document.getElementById('adminHeader').style.display='block';
            document.getElementById('adminMain').style.display='block';
            init();
        } catch(e) { document.getElementById('loginError').style.display='block'; }
    };
    
    // Filters Event Listeners
    document.getElementById('productSearch').onkeyup = renderProducts;
    document.getElementById('deptFilter').onchange = renderProducts; // Added dept filter trigger
    document.getElementById('reqSearch').onkeyup = renderRequests;
    document.getElementById('sellerSearch').onkeyup = renderSellers;
    document.getElementById('orderSearch').onkeyup = renderOrders; // Fixed ID reference
    document.getElementById('orderStatusFilter').onchange = renderOrders; // Added status filter
    document.getElementById('userSearch').onkeyup = renderUsers;

  </script>
</body>
</html>