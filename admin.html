<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>BrahminBazaar Admin Panel</title>
  <style>
    :root{
       /* --- THEME: Light Yellow / Gold --- */
       --primary-dark: #B7950B;
       --primary: #F1C40F;
       --primary-light: #FFF9C4;
       
       --text-dark: #333333;
       --muted: #777777;
       
       --card: #FFFFFF;
       --bg: #FFFEFA;
       
       --radius: 12px;
       --shadow: 0 8px 15px rgba(241, 196, 15, 0.15);
       --max-width: 1400px;
    } 
    
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:var(--bg);color:var(--text-dark); padding-bottom: 40px; -webkit-tap-highlight-color: transparent;}
    
    /* Header */
    header{background:var(--primary); color:#FFF; padding:16px 20px; box-shadow:0 4px 10px rgba(0,0,0,0.1); position: sticky; top:0; z-index: 50;}
    .wrap{max-width:var(--max-width);margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:18px;}
    .brand{display:flex;align-items:center;gap:12px}
    .brand .logo-icon{height:36px;width:auto;display:block; background:#fff; border-radius:4px; padding:2px;}
    h1{font-size:1.3rem;margin:0; font-weight:800; color:#FFF; text-shadow: 0 1px 2px rgba(0,0,0,0.1);}
    
    .back-link{color:var(--primary-dark); background:#fff; padding: 6px 12px; border-radius: 6px; font-size:0.85rem; text-decoration:none; font-weight:700; transition: all .2s}
    .back-link:hover{box-shadow: 0 4px 10px rgba(0,0,0,0.2);}

    /* Login Screen */
    #login-screen{position:fixed;inset:0;background:rgba(255, 254, 250, 0.98); display:flex;align-items:center;justify-content:center;z-index:1000;}
    .login-box{background:var(--card);padding:40px;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.1);max-width:360px;width:92%;text-align:center; border:1px solid var(--primary-light);}
    .login-box h2{color:var(--primary-dark);margin-bottom:20px}
    .login-box input{width:100%;padding:14px;margin-bottom:15px;border:1px solid #ddd;border-radius:8px; outline:none; font-size: 1rem;}
    .login-box input:focus{border-color:var(--primary); box-shadow: 0 0 0 3px rgba(241,196,15,0.2);}
    .login-box button{width:100%;padding:14px;background:var(--primary);color:#000;border:none;border-radius:8px;font-weight:700;cursor:pointer;}
    .login-error { color: red; margin-bottom: 15px; font-size: 0.9rem; display: none; }

    /* Main */
    main{max-width:var(--max-width);margin:22px auto;padding:0 20px;}
    
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:var(--card);padding:20px;border-radius:var(--radius);box-shadow:var(--shadow);border-left:5px solid var(--primary)}
    .stat-card h3{font-size:0.8rem;color:var(--muted);margin-bottom:5px; text-transform: uppercase; letter-spacing: 0.5px;}
    .stat-card .value{font-size:1.8rem;font-weight:800;color:var(--text-dark)}

    /* Tabs */
    .tabs{display:flex;border-bottom:2px solid #EEE;margin-bottom:20px;overflow-x:auto; gap: 20px; padding-bottom: 5px; -webkit-overflow-scrolling: touch;}
    .tab-btn{padding:10px 5px;cursor:pointer;font-weight:600;border:none;background:transparent;border-bottom:3px solid transparent;margin-bottom:-5px;transition:all .2s;white-space:nowrap; color:var(--muted); font-size: 1rem;}
    .tab-btn.active{color:var(--primary-dark);border-bottom:3px solid var(--primary)}
    .tab-content{display:none; animation: fadeIn 0.3s ease;}
    .tab-content.active{display:block}

    /* Tables */
    .table-container{background:var(--card);border-radius:var(--radius);padding:0;box-shadow:var(--shadow);overflow-x:auto; border:1px solid #F0F0F0; -webkit-overflow-scrolling: touch;}
    table{width:100%;border-collapse:collapse;min-width:800px}
    th,td{padding:14px 20px;text-align:left;border-bottom:1px solid #f9f9f9;font-size:0.95rem; vertical-align: middle;}
    th{background:var(--primary-light);color:var(--primary-dark);font-weight:700; font-size: 0.85rem; text-transform: uppercase;}
    .current-price{font-weight:700;color:var(--text-dark)}
    
    .thumb-img { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; border: 1px solid #eee; margin-right: 10px; vertical-align: middle; }

    /* Badges */
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; white-space: nowrap; }
    .badge-in { background-color: #E8F5E9; color: #2E7D32; }
    .badge-out { background-color: #FFEBEE; color: #C62828; }
    .badge-low { background-color: #FFF8E1; color: #F57F17; }
    
    /* Buttons */
    .btn-edit,.btn-save{background:var(--primary);color:#000;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-size:0.85rem;font-weight:600; min-width: 60px;}
    .btn-delete{background:#FFEBEE;color:#D32F2F;border:1px solid #FFCDD2;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:0.85rem;font-weight:600;margin-left:5px}
    .btn-detail{background:var(--primary-light);color:var(--primary-dark);border:1px solid var(--primary);padding:8px 14px;border-radius:6px;cursor:pointer;font-size:0.85rem;font-weight:600; text-decoration: none;}
    
    .add-product-btn{background:#000;color:#FFF;padding:12px 20px;border:none;border-radius:8px;font-weight:700;cursor:pointer;transition:background .2s;}
    .add-product-btn:hover{background:var(--primary); color: #000;}
    .add-product-btn:disabled { background: #999; cursor: not-allowed; }

    /* Top controls */
    .top-controls{display:flex;gap:10px;margin-bottom:15px;align-items:center;flex-wrap:wrap}
    .top-controls input,.top-controls select{padding:12px;border:1px solid #ddd;border-radius:8px;min-width:240px; outline:none; background: #fff; flex: 1;}
    .top-controls input:focus, .top-controls select:focus{border-color:var(--primary);}
    /* On mobile make add button full width */
    @media(max-width: 600px) {
        .add-product-btn { width: 100%; margin-top: 10px; }
        .top-controls input, .top-controls select { min-width: 100%; }
    }

    /* Modal */
    #modalBack{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(2px);z-index:100;display:none;align-items:center;justify-content:center}
    #modalContent{background:var(--card);padding:0;border-radius:var(--radius);box-shadow:0 10px 40px rgba(0,0,0,0.2);max-width:700px;width:94%; max-height: 90vh; display: flex; flex-direction: column;}
    
    .modal-header { padding: 20px; border-bottom: 1px solid #EEE; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { margin: 0; }
    .modal-body { padding: 20px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
    .modal-footer { padding: 20px; border-top: 1px solid #EEE; display: flex; justify-content: flex-end; gap: 10px; background: #FAFAFA; border-radius: 0 0 var(--radius) var(--radius); }

    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-size: 0.85rem; font-weight: 700; color: var(--muted); margin-bottom: 6px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; outline: none; -webkit-appearance: none;}
    .form-group input:focus { border-color: var(--primary); }

    /* Updated Variety & Size Styles */
    .variety-group { border: 1px solid #EEE; border-radius: 8px; padding: 15px; background: #FAFAFA; margin-bottom: 15px; }
    .variety-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .variety-header input { width: auto; flex: 1; margin-right: 10px; font-weight: 700; border: 1px solid #DDD; }
    
    .sizes-container { padding-left: 0; }
    .size-row { display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 8px; margin-bottom: 8px; align-items: center; }
    .size-row input { padding: 8px; border: 1px solid #DDD; border-radius: 6px; font-size: 0.9rem; }
    .btn-remove-row { color: red; background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 0 8px; }
    .btn-small-add { background: #fff; border: 1px dashed #999; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; margin-top: 5px; width: 100%; }
    .btn-small-add:hover { border-color: var(--primary); color: #000; }

    @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

    /* Settings Page */
    .settings-panel { max-width: 600px; background: #fff; padding: 30px; border-radius: 12px; box-shadow: var(--shadow); width: 100%; }
    
    /* Order Detail Styles */
    .order-detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .detail-box { background: #FAFAFA; padding: 15px; border-radius: 8px; border: 1px solid #EEE; }
    .detail-label { font-size: 0.8rem; color: #777; font-weight: 700; text-transform: uppercase; margin-bottom: 5px; }
    .detail-value { font-size: 1rem; font-weight: 600; color: #333; }
    .bill-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #EEE; font-size: 0.9rem; }
    .bill-row.total { border-top: 2px solid #EEE; border-bottom: none; font-weight: 800; font-size: 1.1rem; margin-top: 10px; padding-top: 15px; }

    /* Loader */
    .loader { display: none; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="modalBack" role="dialog" aria-modal="true">
    <div id="modalContent"></div>
  </div>

  <div id="login-screen">
    <div class="login-box">
      <img src="logo.png" alt="BrahminBazaar Admin" style="height:60px; margin-bottom:20px; display:block; margin-left:auto; margin-right:auto;">
      <h2>Admin Access</h2>
      <div id="loginError" class="login-error">Invalid Credentials</div>
      <form id="loginForm">
        <input type="password" id="adminPassword" placeholder="Enter Password" required autocomplete="current-password">
        <button type="submit" id="btnLogin">
            <span class="btn-text">Unlock Panel</span>
            <div class="loader"></div>
        </button>
      </form>
      <p style="margin-top:20px; font-size:0.9rem"><a href="index.html" style="color:var(--muted); text-decoration:none">‚Üê Return to Shop</a></p>
    </div>
  </div>

  <header id="adminHeader" style="display:none;">
    <div class="wrap">
      <div class="brand">
        <img src="logo.png" alt="Logo" class="logo-icon">
        <h1>BrahminBazaar <span style="font-weight:400; opacity:0.8; font-size:0.9em">| Admin</span></h1>
      </div>
      <a class="back-link" href="index.html">Open Shop View</a>
    </div>
  </header>

  <main id="adminMain" style="display:none;">
    <div class="stats-grid">
      <div class="stat-card"><h3>Orders to Process</h3><div class="value" id="pendingOrders">...</div></div>
      <div class="stat-card"><h3>Registered Users</h3><div class="value" id="totalAccounts">...</div></div>
      <div class="stat-card"><h3>Total Products</h3><div class="value" id="totalProducts">...</div></div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="products">Inventory</button>
      <button class="tab-btn" data-tab="orders">Orders</button>
      <button class="tab-btn" data-tab="users">Customers</button>
      <button class="tab-btn" data-tab="settings">Site Settings</button>
    </div>

    <div id="products" class="tab-content active">
      <div class="top-controls">
        <input type="text" id="productSearch" placeholder="Search product name...">
        <select id="deptFilter" style="max-width:180px">
          <option value="All">All Departments</option>
        </select>
        <div style="flex:1"></div>
        <button class="add-product-btn" onclick="openProductModal()">+ Add New Product</button>
      </div>
      
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th style="width:60px">Img</th>
              <th>Product Details</th>
              <th>Category</th>
              <th>Varieties / Pricing</th>
              <th>Stock Status</th>
              <th style="text-align:right">Actions</th>
            </tr>
          </thead>
          <tbody id="productTableBody"></tbody>
        </table>
        <div id="productLoader" style="padding:20px; text-align:center; display:none">Loading inventory...</div>
      </div>
    </div>

    <div id="orders" class="tab-content">
      <div class="top-controls">
        <input type="text" id="orderSearch" placeholder="Search Order ID or Phone...">
        <select id="orderStatusFilter">
            <option value="All">All Status</option>
            <option value="Processing">Processing</option>
            <option value="Completed">Completed</option>
        </select>
      </div>
      <div class="table-container">
        <table>
          <thead><tr><th>ID</th><th>Customer</th><th>Items</th><th>Total</th><th>Status</th><th>Action</th></tr></thead>
          <tbody id="orderTableBody"></tbody>
        </table>
        <div id="ordersLoader" style="padding:20px; text-align:center; display:none">Loading orders...</div>
      </div>
    </div>

    <div id="users" class="tab-content">
      <div class="top-controls">
        <input type="text" id="userSearch" placeholder="Search users...">
      </div>
      <div class="table-container">
        <table>
          <thead><tr><th>Name</th><th>Phone</th><th>Email</th><th>Saved Address</th></tr></thead>
          <tbody id="userTableBody"></tbody>
        </table>
        <div id="usersLoader" style="padding:20px; text-align:center; display:none">Loading users...</div>
      </div>
    </div>

    <div id="settings" class="tab-content">
      <div class="settings-panel">
          <h2 style="margin-bottom:20px; border-bottom:1px solid #EEE; padding-bottom:10px">Checkout Configuration</h2>
          <div style="display:flex; gap:20px; flex-wrap:wrap">
              <div class="form-group" style="flex:1; min-width:200px">
                  <label>CGST (%)</label>
                  <input type="number" id="setCGST" step="0.1" placeholder="e.g. 2.5">
              </div>
              <div class="form-group" style="flex:1; min-width:200px">
                  <label>SGST (%)</label>
                  <input type="number" id="setSGST" step="0.1" placeholder="e.g. 2.5">
              </div>
          </div>
          <div style="display:flex; gap:20px; flex-wrap:wrap">
              <div class="form-group" style="flex:1; min-width:200px">
                  <label>Delivery Fee (‚Çπ)</label>
                  <input type="number" id="setDelivery" placeholder="e.g. 50">
              </div>
              <div class="form-group" style="flex:1; min-width:200px">
                  <label>Processing Fee (‚Çπ)</label>
                  <input type="number" id="setFee" placeholder="e.g. 50">
              </div>
          </div>
          <button class="add-product-btn" id="btnSaveSettings" onclick="saveSettings()">Save Configuration</button>
      </div>
    </div>

  </main>

  <script>
    /*******************************************************
     * BACKEND API LAYER CONFIGURATION
     *******************************************************/
    // Set to 'false' when you are ready to connect to a real server.
    // Set to 'true' to use the browser's localStorage (simulation).
    const USE_MOCK_BACKEND = true; 
    
    // Replace with your real backend URL (e.g., 'https://api.brahminbazaar.com')
    const API_BASE_URL = 'http://localhost:3000/api'; 

    /*******************************************************
     * API SERVICE CLASS (Replaces direct localStorage)
     *******************************************************/
    class ApiService {
        constructor() {
            this.token = sessionStorage.getItem('bb_admin_token') || null;
        }

        // Generic Fetch Wrapper
        async request(endpoint, method = 'GET', body = null) {
            if (USE_MOCK_BACKEND) {
                return this.mockRequest(endpoint, method, body);
            }

            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.token}`
            };

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method,
                    headers,
                    body: body ? JSON.stringify(body) : null
                });
                
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                return await response.json();
            } catch (err) {
                console.error("Network Error:", err);
                throw err;
            }
        }

        // --- Auth ---
        async login(password) {
            // In real backend: POST /login { password } -> return { token }
            return this.request('/login', 'POST', { password });
        }

        // --- Products ---
        async getProducts() { return this.request('/products'); }
        async saveProduct(product) { return this.request('/products', 'POST', product); } // Use POST for upsert or split PUT/POST
        async deleteProduct(id) { return this.request(`/products/${id}`, 'DELETE'); }

        // --- Orders ---
        async getOrders() { return this.request('/orders'); }
        async updateOrderStatus(id, status) { return this.request(`/orders/${id}/status`, 'PATCH', { status }); }

        // --- Users ---
        async getUsers() { return this.request('/users'); }

        // --- Settings ---
        async getSettings() { return this.request('/settings'); }
        async saveSettings(settings) { return this.request('/settings', 'POST', settings); }

        // --- MOCK BACKEND SIMULATION (For Demo/Dev) ---
        async mockRequest(endpoint, method, body) {
            // Simulate network delay
            await new Promise(r => setTimeout(r, 400)); 

            const PRODUCTS_KEY = 'brahminbazaar_admin_products';
            const ORDERS_KEY   = 'brahminbazaar_orders';
            const ACCOUNTS_KEY = 'bb_accounts_v1';
            
            // Helper to Read
            const read = (k) => JSON.parse(localStorage.getItem(k) || (k===ACCOUNTS_KEY?'{}':'[]'));
            // Helper to Write
            const write = (k, v) => localStorage.setItem(k, JSON.stringify(v));

            // Routes
            if (endpoint === '/login' && method === 'POST') {
                if (body.password === 'admin123') {
                    this.token = 'mock_token_' + Date.now();
                    sessionStorage.setItem('bb_admin_token', this.token);
                    return { success: true, token: this.token };
                }
                throw new Error('Invalid Password');
            }

            if (endpoint === '/products') {
                if (method === 'GET') return read(PRODUCTS_KEY);
                if (method === 'POST') {
                    let list = read(PRODUCTS_KEY);
                    const idx = list.findIndex(p => p.id === body.id);
                    if (idx > -1) list[idx] = body;
                    else list.push(body);
                    write(PRODUCTS_KEY, list);
                    return { success: true };
                }
            }

            if (method === 'DELETE' && endpoint.startsWith('/products/')) {
                const id = endpoint.split('/')[2];
                let list = read(PRODUCTS_KEY).filter(p => p.id !== id);
                write(PRODUCTS_KEY, list);
                return { success: true };
            }

            if (endpoint === '/orders') {
                return read(ORDERS_KEY);
            }

            if (method === 'PATCH' && endpoint.includes('/orders/')) {
                // e.g. /orders/123/status
                const id = endpoint.split('/')[2];
                let list = read(ORDERS_KEY);
                let order = list.find(o => o.id === id);
                if (order) order.status = body.status;
                write(ORDERS_KEY, list);
                return { success: true };
            }

            if (endpoint === '/users') {
                return read(ACCOUNTS_KEY);
            }

            if (endpoint === '/settings') {
                if (method === 'GET') {
                    return {
                        cgst: localStorage.getItem('site_cgst') || 2.5,
                        sgst: localStorage.getItem('site_sgst') || 2.5,
                        delivery: localStorage.getItem('site_delivery_fee') || 50,
                        fee: localStorage.getItem('site_processing_fee') || 50
                    };
                }
                if (method === 'POST') {
                    localStorage.setItem('site_cgst', body.cgst);
                    localStorage.setItem('site_sgst', body.sgst);
                    localStorage.setItem('site_delivery_fee', body.delivery);
                    localStorage.setItem('site_processing_fee', body.fee);
                    localStorage.setItem('site_tax_percentage', body.cgst + body.sgst);
                    return { success: true };
                }
            }
        }
    }

    /*************** GLOBAL APP STATE ***************/
    const API = new ApiService();
    let PRODUCTS = [];
    let ORDERS = [];
    let USERS = {}; // Store raw user object
    let USER_LIST = []; // Converted to array for table

    /*************** INITIALIZATION ***************/
    async function init() {
        try {
            // Load all data in parallel
            await Promise.all([
                loadProducts(),
                loadOrders(),
                loadUsers(),
                loadSettings()
            ]);
            
            updateStats();
            populateDeptFilter();
        } catch (e) {
            console.error("Init Error", e);
            alert("Failed to load initial data from server.");
        }
    }

    async function loadProducts() {
        document.getElementById('productLoader').style.display = 'block';
        try {
            PRODUCTS = await API.getProducts();
            // Data Migration fix (same as original)
            PRODUCTS = PRODUCTS.map(p => {
                 if(!p.options || p.options.length === 0) {
                     const price = p.basePrice || 0;
                     p.options = [{ label: 'Standard', price: price, stock: p.inStock ? 50 : 0 }];
                 }
                 if(!p.dept) p.dept = p.mainCategory || 'Groceries';
                 return p;
            });
            renderProducts();
        } finally {
            document.getElementById('productLoader').style.display = 'none';
        }
    }

    async function loadOrders() {
        document.getElementById('ordersLoader').style.display = 'block';
        try {
            ORDERS = await API.getOrders();
            renderOrders();
        } finally {
            document.getElementById('ordersLoader').style.display = 'none';
        }
    }

    async function loadUsers() {
        document.getElementById('usersLoader').style.display = 'block';
        try {
            USERS = await API.getUsers();
            // Convert Object to Array for display
            USER_LIST = [];
            const seen = new Set();
            if (USERS) {
                Object.values(USERS).forEach(u => {
                    if(u && u.email && !seen.has(u.email)) {
                        USER_LIST.push(u);
                        seen.add(u.email);
                    }
                });
            }
            renderUsers();
        } finally {
            document.getElementById('usersLoader').style.display = 'none';
        }
    }

    async function loadSettings() {
        const s = await API.getSettings();
        document.getElementById('setCGST').value = s.cgst;
        document.getElementById('setSGST').value = s.sgst;
        document.getElementById('setDelivery').value = s.delivery;
        document.getElementById('setFee').value = s.fee;
    }

    function updateStats() {
        document.getElementById('pendingOrders').textContent = ORDERS.filter(o => o.status === 'Processing').length;
        document.getElementById('totalAccounts').textContent = USER_LIST.length;
        document.getElementById('totalProducts').textContent = PRODUCTS.length;
    }

    function populateDeptFilter() {
        const depts = new Set(PRODUCTS.map(p => p.dept));
        const sel = document.getElementById('deptFilter');
        sel.innerHTML = '<option value="All">All Departments</option>';
        depts.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d;
            opt.textContent = d;
            sel.appendChild(opt);
        });
    }

    /*************** PRODUCTS LOGIC ***************/
    function renderProducts() {
        const q = document.getElementById('productSearch').value.toLowerCase();
        const dept = document.getElementById('deptFilter').value;
        const tbody = document.getElementById('productTableBody');
        tbody.innerHTML = '';

        const filtered = PRODUCTS.filter(p => {
            if(dept !== 'All' && p.dept !== dept) return false;
            return (p.title + p.subCategory).toLowerCase().includes(q);
        });

        filtered.forEach(p => {
            const totalStock = p.options.reduce((a,b) => a + Number(b.stock), 0);
            const priceRange = p.options.length > 1 
                ? `‚Çπ${Math.min(...p.options.map(o=>o.price))} - ‚Çπ${Math.max(...p.options.map(o=>o.price))}`
                : `‚Çπ${p.options[0].price}`;
            
            let stockBadge = '';
            if(totalStock === 0) stockBadge = '<span class="badge badge-out">Out of Stock</span>';
            else if(totalStock < 10) stockBadge = '<span class="badge badge-low">Low: '+totalStock+'</span>';
            else stockBadge = '<span class="badge badge-in">In Stock: '+totalStock+'</span>';

            const img = (p.images && p.images[0]) ? p.images[0] : (p.img || 'https://via.placeholder.com/40');

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><img src="${img}" class="thumb-img"></td>
                <td>
                    <div style="font-weight:700">${p.title}</div>
                    <div style="font-size:0.8rem; color:#888">${p.id}</div>
                </td>
                <td>${p.dept} <span style="color:#ccc">/</span> ${p.subCategory}</td>
                <td>
                    <div style="font-size:0.9rem">${p.options.length} Variants</div>
                    <div class="current-price">${priceRange}</div>
                </td>
                <td>${stockBadge}</td>
                <td style="text-align:right">
                    <button class="btn-edit" onclick="openProductModal('${p.id}')">Edit</button>
                    <button class="btn-delete" onclick="deleteProduct('${p.id}')">üóë</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- MODAL LOGIC ---
    window.openProductModal = (id = null) => {
        const isEdit = !!id;
        let p = isEdit ? PRODUCTS.find(x => x.id === id) : { 
            title:'', dept:'Groceries', subCategory:'', img:'', 
            options: [] 
        };

        const depts = new Set(PRODUCTS.map(prod => prod.dept));
        if(!depts.has('Groceries')) depts.add('Groceries');
        if(!depts.has('Cosmetics')) depts.add('Cosmetics');
        const deptOptionsHTML = Array.from(depts).map(d => `<option value="${d}">`).join('');

        const modal = document.getElementById('modalContent');
        modal.innerHTML = `
            <div class="modal-header">
                <h3>${isEdit ? 'Edit Product' : 'Add New Product'}</h3>
                <button onclick="closeModal()" style="border:none;background:none;font-size:1.5rem;cursor:pointer;">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Product Title</label>
                    <input id="inpTitle" value="${p.title}" placeholder="e.g. Basmati Rice">
                </div>
                <div style="display:flex; gap:15px; flex-wrap:wrap">
                    <div class="form-group" style="flex:1; min-width:140px">
                        <label>Department</label>
                        <input id="inpDept" list="deptList" value="${p.dept}" placeholder="Select or Type New">
                        <datalist id="deptList">${deptOptionsHTML}</datalist>
                    </div>
                    <div class="form-group" style="flex:1; min-width:140px">
                        <label>Sub-Category</label>
                        <input id="inpCat" value="${p.subCategory}" placeholder="e.g. Dals, Soaps">
                    </div>
                </div>
                <div class="form-group">
                    <label>Image Filename</label>
                    <input id="inpImg" value="${p.images ? p.images[0] : (p.img||'')}" placeholder="e.g. rice.png">
                </div>
                
                <h4 style="margin-top:20px; margin-bottom:10px; border-bottom:1px solid #EEE; padding-bottom:5px">Varieties & Pricing</h4>
                <div id="varietiesWrapper"></div>
                <button onclick="addVarietyBlock()" style="margin-top:10px; background:#000; color:#fff; border:none; padding:12px; border-radius:6px; cursor:pointer; width:100%; font-weight:700">+ Add Variety</button>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal()" style="padding:10px 20px; border:1px solid #ddd; background:#fff; border-radius:6px; cursor:pointer">Cancel</button>
                <button class="add-product-btn" id="btnSaveProd" onclick="saveProduct('${p.id || ''}')">Save Product</button>
            </div>
        `;
        
        const grouped = {};
        if(p.options && p.options.length > 0) {
            p.options.forEach(opt => {
                const vName = opt.variety || 'Standard';
                if(!grouped[vName]) grouped[vName] = [];
                grouped[vName].push(opt);
            });
        } else {
            grouped['Standard'] = []; 
        }

        const wrapper = document.getElementById('varietiesWrapper');
        Object.keys(grouped).forEach(vName => {
            const block = addVarietyBlock(vName);
            grouped[vName].forEach(opt => {
                addSizeRow(block.querySelector('.sizes-container'), opt.size || opt.label, opt.price, opt.stock);
            });
            if(grouped[vName].length === 0) addSizeRow(block.querySelector('.sizes-container'));
        });

        document.getElementById('modalBack').style.display = 'flex';
    };

    window.addVarietyBlock = (name = '') => {
        const div = document.createElement('div');
        div.className = 'variety-group';
        div.innerHTML = `
            <div class="variety-header">
                <input type="text" class="inp-variety-name" placeholder="Variety Name (e.g. Premium)" value="${name}">
                <button class="btn-remove-row" onclick="this.closest('.variety-group').remove()">üóë</button>
            </div>
            <div class="sizes-container"></div>
            <button class="btn-small-add" onclick="addSizeRow(this.previousElementSibling)">+ Add Size</button>
        `;
        document.getElementById('varietiesWrapper').appendChild(div);
        return div;
    };

    window.addSizeRow = (container, size='', price='', stock='') => {
        const row = document.createElement('div');
        row.className = 'size-row';
        row.innerHTML = `
            <input type="text" class="inp-size" placeholder="Size (e.g. 1kg)" value="${size}">
            <input type="number" class="inp-price" placeholder="‚Çπ" value="${price}">
            <input type="number" class="inp-stock" placeholder="Qty" value="${stock}">
            <button class="btn-remove-row" onclick="this.parentElement.remove()">√ó</button>
        `;
        container.appendChild(row);
    };

    window.saveProduct = async (existingId) => {
        const btn = document.getElementById('btnSaveProd');
        btn.textContent = 'Saving...'; btn.disabled = true;

        const title = document.getElementById('inpTitle').value;
        const dept = document.getElementById('inpDept').value;
        const subCat = document.getElementById('inpCat').value;
        const img = document.getElementById('inpImg').value;

        const options = [];
        const varietyGroups = document.querySelectorAll('.variety-group');
        
        varietyGroups.forEach(group => {
            const vName = group.querySelector('.inp-variety-name').value || 'Standard';
            const sizeRows = group.querySelectorAll('.size-row');
            
            sizeRows.forEach(row => {
                const sName = row.querySelector('.inp-size').value;
                const price = row.querySelector('.inp-price').value;
                const stock = row.querySelector('.inp-stock').value;
                
                if(sName && price) {
                    const label = (vName === 'Standard' || !vName) ? sName : `${vName} - ${sName}`;
                    options.push({
                        label: label,
                        variety: vName,
                        size: sName,
                        price: Number(price),
                        stock: Number(stock)
                    });
                }
            });
        });

        if(!title || options.length === 0) {
            btn.textContent = 'Save Product'; btn.disabled = false;
            return alert("Title and at least one size variant required.");
        }

        const productData = {
            id: existingId || title.toLowerCase().replace(/[^a-z0-9]/g, '-'),
            title, dept, subCategory: subCat, 
            images: [img], img, 
            options,
            inStock: true
        };

        if(!existingId && PRODUCTS.find(p=>p.id===productData.id)) {
            btn.textContent = 'Save Product'; btn.disabled = false;
            return alert("Product with this name exists.");
        }

        try {
            await API.saveProduct(productData);
            closeModal();
            loadProducts(); // Refresh list
            updateStats();
            populateDeptFilter(); 
        } catch(e) {
            alert("Error saving product");
            btn.textContent = 'Save Product'; btn.disabled = false;
        }
    };
    
    window.deleteProduct = async (id) => {
        if(confirm("Delete this product?")) {
            await API.deleteProduct(id);
            loadProducts();
            updateStats();
        }
    };
    
    function closeModal() { document.getElementById('modalBack').style.display = 'none'; }

    /*************** ORDERS LOGIC ***************/
    function renderOrders() {
        const filter = document.getElementById('orderStatusFilter').value;
        const q = document.getElementById('orderSearch').value.toLowerCase();
        const ordersWithIndex = ORDERS.map((o, idx) => ({ ...o, originalIndex: idx + 1 }));
        
        const list = ordersWithIndex.filter(o => {
            if(filter !== 'All' && o.status !== filter) return false;
            return (o.id + o.userPhone).toLowerCase().includes(q);
        }).reverse();

        const tbody = document.getElementById('orderTableBody');
        tbody.innerHTML = list.map(o => {
            const userIndex = USER_LIST.findIndex(u => u.email === o.userEmail) + 1;
            const displayUserNum = String(userIndex > 0 ? userIndex : 0).padStart(4, '0');
            const displayOrderNum = String(o.originalIndex).padStart(4, '0');
            const displayID = `${displayUserNum}-${displayOrderNum}`;

            return `
            <tr>
                <td><b>${displayID}</b><br><small style="color:#999">${new Date(o.date).toLocaleDateString()}</small></td>
                <td>${o.userPhone}<br><small>${o.userEmail}</small></td>
                <td>
                    <div style="font-size:0.85rem; max-height:60px; overflow-y:auto">
                        ${o.items.map(i => `<div>${i.title} (${i.size}) x${i.packs}</div>`).join('')}
                    </div>
                </td>
                <td class="current-price">‚Çπ${o.total.toFixed(2)}</td>
                <td><span class="badge ${o.status==='Completed'?'badge-in':'badge-low'}">${o.status}</span></td>
                <td style="display:flex; gap:10px">
                    <button class="btn-detail" onclick="viewOrder('${o.id}', '${displayID}')">View</button>
                    ${o.status!=='Completed' ? `<button class="btn-save" onclick="markComplete('${o.id}')">‚úì Done</button>` : ''}
                </td>
            </tr>
            `;
        }).join('');
    }

    window.viewOrder = (oid, displayID) => {
        const o = ORDERS.find(x => x.id === oid);
        if(!o) return;
        
        let user = USERS[o.userEmail] || USERS[o.userPhone] || { name: 'Guest', address: 'Not Found' };
        
        const freq = ORDERS.filter(ord => ord.userEmail === o.userEmail).length;
        const ordinal = (n) => n + (["st","nd","rd"][((n+90)%100-10)%10-1]||"th");

        const cgstRate = parseFloat(localStorage.getItem('site_cgst') || 2.5);
        const sgstRate = parseFloat(localStorage.getItem('site_sgst') || 2.5);
        const delFee = parseFloat(localStorage.getItem('site_delivery_fee') || 50);
        const procFee = parseFloat(localStorage.getItem('site_processing_fee') || 50);
        
        let subtotal = 0;
        o.items.forEach(i => subtotal += (i.price * i.packs));
        
        const cgstAmt = subtotal * (cgstRate/100);
        const sgstAmt = subtotal * (sgstRate/100);
        
        const modal = document.getElementById('modalContent');
        modal.innerHTML = `
            <div class="modal-header">
                <h3>Order #${displayID}</h3>
                <button onclick="closeModal()" style="border:none;background:none;font-size:1.5rem;cursor:pointer;">√ó</button>
            </div>
            <div class="modal-body">
                <div class="order-detail-grid">
                    <div class="detail-box">
                        <div class="detail-label">Customer Info</div>
                        <div class="detail-value">${user.name}</div>
                        <div style="font-size:0.9rem; margin-top:4px">${o.userPhone}</div>
                        <div style="font-size:0.9rem; color:#555; margin-top:8px; line-height:1.4">${user.address || o.address || 'Address not provided'}</div>
                    </div>
                    <div class="detail-box">
                        <div class="detail-label">Insights</div>
                        <div class="detail-value">${ordinal(freq)} Order</div>
                        <div style="font-size:0.9rem; margin-top:4px">from this customer</div>
                        <div class="detail-label" style="margin-top:15px">Date & Time</div>
                        <div style="font-size:0.9rem">${new Date(o.date).toLocaleString()}</div>
                    </div>
                </div>

                <h4 style="margin-bottom:10px; border-bottom:1px solid #EEE; padding-bottom:5px">Order Items</h4>
                <div style="background:#FAFAFA; border:1px solid #EEE; border-radius:8px; overflow:hidden">
                    <table style="width:100%; min-width:auto">
                        <thead style="background:#EEE; font-size:0.85rem"><tr><th>Item</th><th>Var</th><th>Qty</th><th style="text-align:right">Price</th></tr></thead>
                        <tbody>
                            ${o.items.map(i => `
                                <tr>
                                    <td style="padding:10px">${i.title}</td>
                                    <td style="padding:10px">${i.size}</td>
                                    <td style="padding:10px">x${i.packs}</td>
                                    <td style="padding:10px; text-align:right">‚Çπ${(i.price * i.packs).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                <h4 style="margin:20px 0 10px; border-bottom:1px solid #EEE; padding-bottom:5px">Bill Summary</h4>
                <div class="detail-box">
                    <div class="bill-row"><span>Item Total</span> <span>‚Çπ${subtotal.toFixed(2)}</span></div>
                    <div class="bill-row"><span>CGST (${cgstRate}%)</span> <span>‚Çπ${cgstAmt.toFixed(2)}</span></div>
                    <div class="bill-row"><span>SGST (${sgstRate}%)</span> <span>‚Çπ${sgstAmt.toFixed(2)}</span></div>
                    <div class="bill-row"><span>Delivery Fee</span> <span>‚Çπ${delFee.toFixed(2)}</span></div>
                    <div class="bill-row"><span>Processing Fee</span> <span>‚Çπ${procFee.toFixed(2)}</span></div>
                    <div class="bill-row total"><span>Grand Total</span> <span>‚Çπ${o.total.toFixed(2)}</span></div>
                </div>
            </div>
        `;
        document.getElementById('modalBack').style.display = 'flex';
    };

    window.markComplete = async (oid) => {
        const btn = event.target;
        btn.textContent = '...';
        await API.updateOrderStatus(oid, 'Completed');
        loadOrders();
        updateStats();
    };

    /*************** USERS LOGIC ***************/
    function renderUsers() {
        const q = document.getElementById('userSearch').value.toLowerCase();
        const tbody = document.getElementById('userTableBody');
        
        tbody.innerHTML = USER_LIST.filter(u => u.name.toLowerCase().includes(q)).map(u => `
            <tr>
                <td>${u.name}</td>
                <td>${u.phone}</td>
                <td>${u.email}</td>
                <td style="font-size:0.85rem; color:#666; max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">${u.address}</td>
            </tr>
        `).join('');
    }

    /*************** SETTINGS LOGIC ***************/
    window.saveSettings = async () => {
        const btn = document.getElementById('btnSaveSettings');
        btn.textContent = 'Saving...'; btn.disabled = true;

        const settings = {
            cgst: parseFloat(document.getElementById('setCGST').value) || 0,
            sgst: parseFloat(document.getElementById('setSGST').value) || 0,
            delivery: document.getElementById('setDelivery').value,
            fee: document.getElementById('setFee').value
        };

        try {
            await API.saveSettings(settings);
            alert("Configuration Saved!");
        } catch(e) { alert("Error saving settings"); }
        finally { btn.textContent = 'Save Configuration'; btn.disabled = false; }
    };

    /*************** TABS & LOGIN ***************/
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(btn.dataset.tab).classList.add('active');
        };
    });

    document.getElementById('loginForm').onsubmit = async (e) => {
        e.preventDefault();
        const pw = document.getElementById('adminPassword').value;
        const btn = document.getElementById('btnLogin');
        const loader = btn.querySelector('.loader');
        const text = btn.querySelector('.btn-text');
        const err = document.getElementById('loginError');

        text.style.display = 'none';
        loader.style.display = 'block';
        err.style.display = 'none';
        btn.disabled = true;

        try {
            await API.login(pw);
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('adminHeader').style.display = 'block';
            document.getElementById('adminMain').style.display = 'block';
            init();
        } catch(e) {
            err.style.display = 'block';
            btn.disabled = false;
        } finally {
            text.style.display = 'block';
            loader.style.display = 'none';
        }
    };

    // Filters
    document.getElementById('productSearch').onkeyup = renderProducts;
    document.getElementById('deptFilter').onchange = renderProducts;
    document.getElementById('orderSearch').onkeyup = renderOrders;
    document.getElementById('orderStatusFilter').onchange = renderOrders;
    document.getElementById('userSearch').onkeyup = renderUsers;

  </script>
</body>
</html>