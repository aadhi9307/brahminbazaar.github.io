<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>My Profile — BrahminBazaar</title>
  <style>
    :root{
      /* --- THEME: White & Light Yellow/Gold (Matches index.html) --- */
      --yellow-outline: #F1C40F;
      --yellow-hover: #FFFDE7;
      --yellow-text: #D4AC0D;
      --star-gold: #FFC107;
      
      --bg: #FFFEFA;
      --card: #FFFFFF;
      --text: #333333;
      --muted: #777777;
      --footer: #000000;
      --footer-text: #E0E0E0;

      --shadow: 0 4px 15px rgba(0,0,0,0.03); 
      --radius: 12px;
      --max: 1000px; /* Slightly narrower for profile focus */
    }
  
    *{box-sizing:border-box;margin:0;padding:0; -webkit-tap-highlight-color: transparent;}
    html, body { height:100%; }
    body{min-height:100%; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;}
    
    /* Header (Simplified for Profile Page) */
    header{background:var(--card);border-bottom:1px solid rgba(241, 196, 15, 0.6); position:sticky;top:0;z-index:60}
    .wrap{
      max-width:var(--max);margin:0 auto;
      padding:12px 18px; 
      display:flex; justify-content:space-between; align-items:center;
    }
    .brand{display:flex;gap:14px;align-items:center; text-decoration:none;}
    .logo{width:60px;height:48px;border-radius:8px;overflow:hidden;border:1px solid #f0f0f0;background:#FFF;display:flex;align-items:center;justify-content:center}
    .logo img{width:100%;height:100%;object-fit:cover}
    .brand h1{font-size:1.2rem;font-weight:800;color:var(--yellow-text);line-height:1; margin:0}
    
    .back-btn{
      text-decoration:none; color:var(--text); font-weight:700; font-size:14px;
      display:flex; align-items:center; gap:6px;
      padding:8px 14px; border-radius:8px; border:1px solid #EEE;
    }
    .back-btn:hover{ background:var(--yellow-hover); border-color:var(--yellow-outline); }

    /* Main Layout */
    main{max-width:var(--max);margin:30px auto;padding:0 18px; display:grid; grid-template-columns: 240px 1fr; gap:30px;}
    @media (max-width:768px){ main{grid-template-columns:1fr} }

    /* Sidebar Navigation */
    .sidebar{display:flex; flex-direction:column; gap:8px;}
    .nav-btn{
      text-align:left; background:transparent; border:none; padding:12px 16px;
      font-size:15px; font-weight:600; color:var(--text); border-radius:10px; cursor:pointer;
      transition:all 0.2s;
    }
    .nav-btn:hover{ background:var(--yellow-hover); }
    .nav-btn.active{ background:var(--yellow-outline); color:#FFF; box-shadow:0 4px 10px rgba(241, 196, 15, 0.3); }
    
    .logout-btn{
      margin-top:20px; color:#D32F2F; border:1px solid #FFEAEA; background:#FFF;
    }
    .logout-btn:hover{ background:#FFF5F5; border-color:#FFCDD2; }

    /* Content Area */
    .content{ background:var(--card); border-radius:16px; box-shadow:var(--shadow); border:1px solid #F0F0F0; padding:24px; min-height:400px; position: relative;}
    
    h2{ margin-bottom:20px; color:var(--text); font-size:1.4rem; }
    
    /* Forms */
    .form-group{margin-bottom:16px;}
    label{display:block; margin-bottom:6px; font-weight:700; font-size:13px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px;}
    input, textarea{
      width:100%; padding:12px 14px; border:1px solid #E0E0E0; border-radius:10px;
      font-size:15px; outline:none; font-family:inherit; transition:border 0.2s; -webkit-appearance: none;
    }
    input:focus, textarea:focus{ border-color:var(--yellow-outline); background:var(--yellow-hover); }
    
    /* Phone Input Specific Styles */
    .phone-group { display: flex; gap: 10px; align-items: stretch; }
    .phone-prefix { width: 70px; background: #F5F5F5; color: #555; text-align: center; border: 1px solid #E0E0E0; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; user-select: none; }
    
    .save-btn{
      background:var(--card); color:var(--text); border:2px solid var(--yellow-outline);
      padding:12px 24px; border-radius:10px; font-weight:800; cursor:pointer; margin-top:10px;
    }
    .save-btn:hover{ background:var(--yellow-outline); color:#FFF; }
    .save-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    /* Sections */
    .section{ display:none; }
    .section.active{ display:block; animation:fadeIn 0.3s ease; }
    
    /* Order History Styles */
    .order-card{ border:1px solid #EEE; border-radius:12px; padding:16px; margin-bottom:14px; }
    .order-header{ display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid #FAFAFA; padding-bottom:8px; }
    .order-id{ font-weight:700; color:var(--text); }
    .order-date{ font-size:13px; color:var(--muted); }
    .order-total{ font-weight:800; color:var(--yellow-text); }
    .order-status{ font-size:12px; padding:4px 8px; background:#F5F5F5; border-radius:6px; font-weight:600; }

    .item-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; font-size: 13px; color: #555; border-bottom: 1px dashed #FAFAFA; }
    .btn-rate { background: #fff; border: 1px solid #DDD; padding: 2px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; transition: 0.2s; }
    .btn-rate:hover { border-color: var(--yellow-outline); color: var(--yellow-text); }

    /* Notifications (Empty State) */
    .empty-state{ text-align:center; padding:40px; color:var(--muted); }
    
    /* Modals */
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.5); backdrop-filter:blur(3px); display:none;align-items:center;justify-content:center;z-index:120; opacity: 0; transition: opacity 0.3s;}
    .modal-back.show{opacity: 1;}
    .modal{background:#fff;padding:24px;border-radius:20px;max-width:400px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.2); border:1px solid #EEE; transform: translateY(20px); transition: transform 0.3s; text-align: center;}
    .modal-back.show .modal{transform: translateY(0);}

    /* Star Rating */
    .star-rating { display: flex; justify-content: center; gap: 8px; font-size: 2rem; color: #EEE; cursor: pointer; margin: 20px 0; }
    .star-rating span.active { color: var(--star-gold); }
    
    /* Loader */
    .loader-overlay { position: absolute; inset:0; background:rgba(255,255,255,0.8); display:none; align-items:center; justify-content:center; z-index: 50; border-radius: 16px; }
    .spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--yellow-outline); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

    /* Footer */
    footer{background:var(--footer);color:var(--footer-text); margin-top:auto; padding:20px; text-align:center; font-size:0.9rem;}
    footer a{ color:var(--yellow-outline); text-decoration:none; }
  </style>
</head>
<body>

  <header>
    <div class="wrap">
      <a href="index.html" class="brand">
        <div class="logo"><img src="logo.png" alt="BB"></div>
        <h1>BrahminBazaar</h1>
      </a>
      <a href="index.html" class="back-btn">← Back to Shop</a>
    </div>
  </header>

  <main>
    <aside class="sidebar">
      <button class="nav-btn active" onclick="showSection('profile', this)">My Profile</button>
      <button class="nav-btn" onclick="showSection('orders', this)">My Orders</button>
      <button class="nav-btn" onclick="showSection('offers', this)">Notifications & Offers</button>
      <button class="nav-btn logout-btn" onclick="logout()">Logout</button>
    </aside>

    <div class="content">
      <div id="contentLoader" class="loader-overlay"><div class="spinner"></div></div>
      
      <div id="profile" class="section active">
        <h2>Edit Profile</h2>
        <form id="profileForm">
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="p_name" placeholder="First Name  Last Name" required />
          </div>
          <div class="form-group">
            <label>Phone Number</label>
            <div class="phone-group">
                <div class="phone-prefix">+91</div>
                <input type="tel" id="p_phone" maxlength="10" placeholder="10 Digit Number" required oninput="this.value = this.value.replace(/[^0-9]/g, '')" />
            </div>
          </div>
          <div class="form-group">
            <label>Email Address</label>
            <input type="email" id="p_email" required />
          </div>
          <div class="form-group">
            <label>Delivery Address</label>
            <textarea id="p_addr" rows="3" required></textarea>
          </div>
          <div class="form-group" style="margin-top:24px; border-top:1px solid #EEE; paddingTop:16px;">
            <label>New Password <span style="font-weight:400;text-transform:none;color:#999">(Leave blank to keep current)</span></label>
            <input type="password" id="p_pass" placeholder="Enter new password" />
          </div>
          <button type="submit" id="btnSaveProfile" class="save-btn">Save Changes</button>
        </form>
      </div>

      <div id="orders" class="section">
        <h2>My Orders</h2>
        <div id="orderList"></div>
      </div>

      <div id="offers" class="section">
        <h2>Notifications</h2>
        <div class="empty-state">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#DDD" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
          <p style="margin-top:10px">No new offers or notifications at the moment.</p>
        </div>
      </div>

    </div>
  </main>

  <div id="reviewBack" class="modal-back">
    <div class="modal">
      <h3>Rate Item</h3>
      <p style="color:#777; font-size:0.9rem">How was the product?</p>
      <div id="starContainer" class="star-rating">
         <span onclick="setRating(1)">★</span>
         <span onclick="setRating(2)">★</span>
         <span onclick="setRating(3)">★</span>
         <span onclick="setRating(4)">★</span>
         <span onclick="setRating(5)">★</span>
      </div>
      <div style="display:flex; gap:10px; justify-content:center;">
          <button onclick="closeReview()" class="save-btn" style="background:#fff; border-color:#ddd; margin-top:0">Cancel</button>
          <button onclick="submitReview()" class="save-btn" style="margin-top:0">Submit</button>
      </div>
    </div>
  </div>

  <footer>
    <div>© <span id="year"></span> Vyaasa Trade & Logistix LLP.</div>
    <div style="margin-top:4px; font-size:0.85rem"><a href="https://vyasagroup.com" target="_blank">vyasagroup.com</a></div>
  </footer>

  <script>
    /*******************************************************
     * BACKEND API LAYER CONFIGURATION
     *******************************************************/
    const USE_MOCK_BACKEND = true; 
    const API_BASE_URL = 'http://localhost:3000/api'; 

    /*******************************************************
     * API SERVICE CLASS
     *******************************************************/
    class ApiService {
        constructor() {
            // Get session from LS (simulating an Auth Token)
            const sess = localStorage.getItem('bb_user_v1');
            this.user = sess ? JSON.parse(sess) : null;
        }

        get isLoggedIn() { return !!this.user; }

        async request(endpoint, method = 'GET', body = null) {
            if (USE_MOCK_BACKEND) {
                return this.mockRequest(endpoint, method, body);
            }

            // Real Fetch Implementation
            const headers = { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.user ? this.user.token : ''}` 
            };

            try {
                const res = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method, headers, body: body ? JSON.stringify(body) : null
                });
                if(!res.ok) throw new Error(res.statusText);
                return await res.json();
            } catch(e) {
                console.error("API Error", e);
                throw e;
            }
        }

        // --- Mock Backend Simulation ---
        async mockRequest(endpoint, method, body) {
            await new Promise(r => setTimeout(r, 400)); // Sim delay

            const ORDERS_KEY   = 'brahminbazaar_orders';
            const ACCOUNTS_KEY = 'bb_accounts_v1';
            const SESSION_KEY  = 'bb_user_v1';

            const read = (k) => JSON.parse(localStorage.getItem(k) || (k===ACCOUNTS_KEY?'{}':'[]'));
            const write = (k, v) => localStorage.setItem(k, JSON.stringify(v));

            if(endpoint === '/profile') {
                if(method === 'GET') {
                    if(!this.user) throw new Error("Unauthorized");
                    const accounts = read(ACCOUNTS_KEY);
                    // Find latest data using email or phone
                    const acc = accounts[this.user.email] || accounts[this.user.phone] || this.user;
                    return acc;
                }
                if(method === 'PUT') {
                    const { name, phone, email, address, pass } = body;
                    const accounts = read(ACCOUNTS_KEY);
                    
                    // Identify old key
                    const oldKey = this.user.email || this.user.phone;
                    const oldAcc = accounts[oldKey];

                    // Check collisions if changing email/phone
                    if(email !== this.user.email && accounts[email]) throw new Error("Email taken");
                    if(phone !== this.user.phone && accounts[phone]) throw new Error("Phone taken");

                    const newAcc = { 
                        ...oldAcc, 
                        name, phone, email, address,
                        pass: pass || oldAcc.pass 
                    };

                    // Update Map
                    delete accounts[oldKey]; // Remove old entry
                    accounts[email] = newAcc; // Add new entry (keyed by email usually)
                    
                    write(ACCOUNTS_KEY, accounts);
                    
                    // Update Session
                    const sess = { name, phone, email, address };
                    write(SESSION_KEY, sess);
                    this.user = sess; // Update local memory
                    
                    return { success: true, user: sess };
                }
            }

            if(endpoint === '/my-orders') {
                const allOrders = read(ORDERS_KEY);
                // Filter securely
                return allOrders.filter(o => 
                    o.userEmail === this.user.email && 
                    o.userPhone === this.user.phone
                );
            }

            if(endpoint === '/submit-review') {
                const { orderId, itemIdx, rating } = body;
                const allOrders = read(ORDERS_KEY);
                const order = allOrders.find(o => o.id === orderId);
                
                if(order && order.items[itemIdx]) {
                    order.items[itemIdx].rating = rating;
                    write(ORDERS_KEY, allOrders);
                    return { success: true };
                }
                throw new Error("Order not found");
            }
        }

        // Public Methods
        async getProfile() { return this.request('/profile'); }
        async updateProfile(data) { return this.request('/profile', 'PUT', data); }
        async getOrders() { return this.request('/my-orders'); }
        async submitReview(data) { return this.request('/submit-review', 'POST', data); }
        
        logout() {
            localStorage.removeItem('bb_user_v1');
            window.location.href = 'index.html';
        }
    }

    /* --- GLOBALS --- */
    const API = new ApiService();
    let MY_ORDERS = [];
    
    // Review State
    let currentReviewOrder = null;
    let currentReviewItemIdx = null;
    let currentRatingVal = 0;

    document.getElementById('year').textContent = new Date().getFullYear();

    /* --- INIT --- */
    async function init(){
      if(!API.isLoggedIn){
        alert("You are not logged in. Redirecting to Shop.");
        window.location.href = 'index.html';
        return;
      }

      showLoader(true);
      try {
          const [profile, orders] = await Promise.all([
              API.getProfile(),
              API.getOrders()
          ]);
          
          fillForm(profile);
          MY_ORDERS = orders || [];
          renderOrders();
      } catch(e) {
          console.error(e);
          alert("Error loading profile data.");
      } finally {
          showLoader(false);
      }
    }

    function showLoader(b) {
        document.getElementById('contentLoader').style.display = b ? 'flex' : 'none';
    }

    /* --- TABS --- */
    window.showSection = function(id, btn){
      document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      
      document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
      btn.classList.add('active');
    }

    /* --- FORM LOGIC --- */
    function fillForm(acc){
      document.getElementById('p_name').value = acc.name || '';
      document.getElementById('p_phone').value = (acc.phone || '').replace(/[^0-9]/g, '').slice(-10); 
      document.getElementById('p_email').value = acc.email || '';
      document.getElementById('p_addr').value = acc.address || '';
    }

    document.getElementById('profileForm').onsubmit = async (e) => {
      e.preventDefault();
      
      const newName = document.getElementById('p_name').value.trim();
      const newPhone = document.getElementById('p_phone').value.trim();
      const newEmail = document.getElementById('p_email').value.trim();
      const newAddr = document.getElementById('p_addr').value.trim();
      const newPass = document.getElementById('p_pass').value;

      if(newName.split(/\s+/).length < 2) return alert("Please enter both First Name and Last Name.");
      if(newPhone.length !== 10) return alert("Phone number must be exactly 10 digits.");

      const btn = document.getElementById('btnSaveProfile');
      btn.textContent = "Saving...";
      btn.disabled = true;

      try {
          await API.updateProfile({
              name: newName,
              phone: newPhone,
              email: newEmail,
              address: newAddr,
              pass: newPass
          });
          alert('Profile updated successfully!');
          // Optionally refresh page to ensure consistent state
          window.location.reload(); 
      } catch(err) {
          alert("Update Failed: " + err.message);
          btn.textContent = "Save Changes";
          btn.disabled = false;
      }
    };

    /* --- ORDERS & REVIEWS LOGIC --- */
    function renderOrders(){
      const container = document.getElementById('orderList');
      container.innerHTML = '';

      if(MY_ORDERS.length === 0){
        container.innerHTML = `
          <div class="empty-state">
            <p>You haven't placed any orders yet.</p>
            <a href="index.html" style="color:var(--yellow-text); font-weight:700; text-decoration:none; display:inline-block; margin-top:8px">Start Shopping</a>
          </div>`;
        return;
      }

      // Clone and reverse for display
      [...MY_ORDERS].reverse().forEach(order => {
        const div = document.createElement('div');
        div.className = 'order-card';
        
        const dateStr = order.date ? new Date(order.date).toLocaleDateString() : 'Recent';
        const totalStr = order.total ? '₹' + Number(order.total).toFixed(2) : '—';
        const itemsCount = order.items ? order.items.length : 0;
        
        // Items Rendering with Rate Button
        let itemsHtml = '';
        if(order.items && order.items.length){
          itemsHtml = '<div style="margin-top:10px; border-top:1px solid #F9F9F9; padding-top:8px">';
          order.items.forEach((item, idx) => {
              const hasRated = item.rating > 0;
              const rateBtn = hasRated 
                  ? `<span style="color:var(--star-gold); font-weight:700; font-size:12px">★ ${item.rating}</span>` 
                  : `<button class="btn-rate" onclick="initReview('${order.id}', ${idx})">Rate</button>`;
              
              itemsHtml += `
                <div class="item-row">
                    <span>${item.title} (${item.size}) x${item.packs}</span>
                    ${rateBtn}
                </div>`;
          });
          itemsHtml += '</div>';
        }

        const displayId = order.id.includes('-') ? order.id : ('#' + order.id);

        div.innerHTML = `
          <div class="order-header">
            <div>
              <div class="order-id">Order ${displayId}</div>
              <div class="order-date">${dateStr}</div>
            </div>
            <div style="text-align:right">
              <div class="order-total">${totalStr}</div>
              <div class="order-status">${order.status || 'Pending'}</div>
            </div>
          </div>
          <div style="font-size:13px; font-weight:600; color:var(--muted)">${itemsCount} Items</div>
          ${itemsHtml}
        `;
        container.appendChild(div);
      });
    }

    // --- Review Handling ---
    window.initReview = (orderId, itemIdx) => {
        currentReviewOrder = orderId;
        currentReviewItemIdx = itemIdx;
        currentRatingVal = 0;
        updateStarsUI();
        
        const el = document.getElementById('reviewBack');
        el.style.display = 'flex';
        // Trigger reflow for animation
        el.offsetHeight; 
        el.classList.add('show');
    };

    window.closeReview = () => {
        const el = document.getElementById('reviewBack');
        el.classList.remove('show');
        setTimeout(() => el.style.display = 'none', 300);
    };

    window.setRating = (n) => {
        currentRatingVal = n;
        updateStarsUI();
    };

    function updateStarsUI() {
        const spans = document.querySelectorAll('#starContainer span');
        spans.forEach((span, idx) => {
            if(idx < currentRatingVal) span.classList.add('active');
            else span.classList.remove('active');
        });
    }

    window.submitReview = async () => {
        if(currentRatingVal === 0) return alert("Please select a star rating.");
        
        showLoader(true);
        try {
            await API.submitReview({
                orderId: currentReviewOrder,
                itemIdx: currentReviewItemIdx,
                rating: currentRatingVal
            });
            
            // Update local UI
            const order = MY_ORDERS.find(o => o.id === currentReviewOrder);
            if(order && order.items[currentReviewItemIdx]) {
                order.items[currentReviewItemIdx].rating = currentRatingVal;
            }
            
            closeReview();
            renderOrders();
            alert("Thank you for your rating!");
        } catch(e) {
            alert("Failed to submit review.");
        } finally {
            showLoader(false);
        }
    };

    /* --- LOGOUT --- */
    window.logout = function(){
      if(confirm('Are you sure you want to log out?')){
        API.logout();
      }
    }

    // Run
    init();

  </script>
</body>
</html>